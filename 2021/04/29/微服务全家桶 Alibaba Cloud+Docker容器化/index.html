<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="微服务全家桶 Alibaba Cloud+Docker容器化"><meta name="keywords" content="docker,Nacos,Ribbon,负载均衡,Open-Feign,Sentinel,Zipkin,Sleuth,Gateway"><meta name="author" content="Kaluna"><meta name="copyright" content="Kaluna"><title>微服务全家桶 Alibaba Cloud+Docker容器化 | 嘿，走钢索的人</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="嘿，走钢索的人" type="application/atom+xml">
</head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#微服务全家桶-Alibaba-Cloud-Docker容器化实战"><span class="toc-number">1.</span> <span class="toc-text">微服务全家桶 Alibaba Cloud+Docker容器化实战</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#微服务AlibabaCloud-全家桶-Docker实战介绍"><span class="toc-number">1.1.</span> <span class="toc-text">微服务AlibabaCloud 全家桶+Docker实战介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#学习目的"><span class="toc-number">1.2.</span> <span class="toc-text">学习目的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#技术栈和环境说明"><span class="toc-number">1.3.</span> <span class="toc-text">技术栈和环境说明</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#分布式架构核心知识"><span class="toc-number">2.</span> <span class="toc-text">分布式架构核心知识</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#分布式架构"><span class="toc-number">2.1.</span> <span class="toc-text">分布式架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#微服务全家桶架构组成"><span class="toc-number">2.2.</span> <span class="toc-text">微服务全家桶架构组成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#业界微服务架构常见解决方案"><span class="toc-number">2.3.</span> <span class="toc-text">业界微服务架构常见解决方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AlibabaCloud核心组件介绍"><span class="toc-number">2.4.</span> <span class="toc-text">AlibabaCloud核心组件介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#在线教育环微服务模块划分和环境准备"><span class="toc-number">2.5.</span> <span class="toc-text">在线教育环微服务模块划分和环境准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#小滴课堂在线教育数据库表介绍和导入"><span class="toc-number">2.6.</span> <span class="toc-text">小滴课堂在线教育数据库表介绍和导入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Maven聚合工程创建微服务项目"><span class="toc-number">2.7.</span> <span class="toc-text">Maven聚合工程创建微服务项目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AlibabaCloud微服务Mybatis连接MySQL数据库"><span class="toc-number">2.8.</span> <span class="toc-text">AlibabaCloud微服务Mybatis连接MySQL数据库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#微服务之间的调用-下单购买视频"><span class="toc-number">2.9.</span> <span class="toc-text">微服务之间的调用-下单购买视频</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#AlibabaCloud核心组件服务治理Nacos实战"><span class="toc-number">3.</span> <span class="toc-text">AlibabaCloud核心组件服务治理Nacos实战</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#什么是注册中心和常见的注册中心有哪些"><span class="toc-number">3.1.</span> <span class="toc-text">什么是注册中心和常见的注册中心有哪些</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AlibabaCloud注册中心Nacos实战"><span class="toc-number">3.2.</span> <span class="toc-text">AlibabaCloud注册中心Nacos实战</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基于nacos实现订单-视频服务之间的调用"><span class="toc-number">3.3.</span> <span class="toc-text">基于nacos实现订单-视频服务之间的调用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#常见的负载均衡策略和解决方案"><span class="toc-number">3.4.</span> <span class="toc-text">常见的负载均衡策略和解决方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AlibabaCloud集成Ribbon实现负载均衡"><span class="toc-number">3.5.</span> <span class="toc-text">AlibabaCloud集成Ribbon实现负载均衡</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#负载均衡进阶之Ribbon和Feign实战-源码分析"><span class="toc-number">4.</span> <span class="toc-text">负载均衡进阶之Ribbon和Feign实战+源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ribbon服务间调用负载均衡源码分析"><span class="toc-number">4.1.</span> <span class="toc-text">ribbon服务间调用负载均衡源码分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AlibabaCloud负载均衡策略调整实战"><span class="toc-number">4.2.</span> <span class="toc-text">AlibabaCloud负载均衡策略调整实战</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#负载均衡组件Open-Feign介绍"><span class="toc-number">4.3.</span> <span class="toc-text">负载均衡组件Open-Feign介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#改造微服务-集成Open-Feign实现远程方法调用"><span class="toc-number">4.4.</span> <span class="toc-text">改造微服务 集成Open-Feign实现远程方法调用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#不可不知道的分布式架构理论"><span class="toc-number">5.</span> <span class="toc-text">不可不知道的分布式架构理论</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#分布式应用核心CAP知识"><span class="toc-number">5.1.</span> <span class="toc-text">分布式应用核心CAP知识</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CAP里面下的注册中心选择思考"><span class="toc-number">5.2.</span> <span class="toc-text">CAP里面下的注册中心选择思考</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一致性和可用性的权衡结果-BASE理论"><span class="toc-number">5.3.</span> <span class="toc-text">一致性和可用性的权衡结果 BASE理论</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#高并发下的微服务架构存在的问题和解决方案"><span class="toc-number">6.</span> <span class="toc-text">高并发下的微服务架构存在的问题和解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#面向失败编程-微服务架构容错方案介绍"><span class="toc-number">6.1.</span> <span class="toc-text">面向失败编程-微服务架构容错方案介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#分布式系统的流量防卫兵-Sentinel介绍"><span class="toc-number">6.2.</span> <span class="toc-text">分布式系统的流量防卫兵-Sentinel介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#流量防卫兵-Sentinel依赖引入和控制台搭建"><span class="toc-number">6.3.</span> <span class="toc-text">流量防卫兵-Sentinel依赖引入和控制台搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AliababCloud微服务整合Sentinel限流配置实战"><span class="toc-number">6.4.</span> <span class="toc-text">AliababCloud微服务整合Sentinel限流配置实战</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Sentinel多种流空规则和实战"><span class="toc-number">7.</span> <span class="toc-text">Sentinel多种流空规则和实战</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Sentinel流量控制详细操作"><span class="toc-number">7.1.</span> <span class="toc-text">Sentinel流量控制详细操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基于并发线程数进行限流配置实操"><span class="toc-number">7.2.</span> <span class="toc-text">基于并发线程数进行限流配置实操</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#流控规则效果-直接拒绝-冷启动预热-匀速排队讲解"><span class="toc-number">7.3.</span> <span class="toc-text">流控规则效果-直接拒绝-冷启动预热-匀速排队讲解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sentinel-微服务高可用利器-熔断降级规则"><span class="toc-number">7.4.</span> <span class="toc-text">Sentinel-微服务高可用利器-熔断降级规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sentinel的熔断状态和恢复"><span class="toc-number">7.5.</span> <span class="toc-text">Sentinel的熔断状态和恢复</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sentinel整合AlibabaCloud微服务熔断实操"><span class="toc-number">7.6.</span> <span class="toc-text">Sentinel整合AlibabaCloud微服务熔断实操</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Sentinel自定义异常-整合Open-Feign"><span class="toc-number">8.</span> <span class="toc-text">Sentinel自定义异常-整合Open-Feign</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#AlibabaCloud版本升级-自定义降级异常-sentinel不向下兼容的坑"><span class="toc-number">8.1.</span> <span class="toc-text">AlibabaCloud版本升级-自定义降级异常-sentinel不向下兼容的坑</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sentinel自定义降级异常数据开发实战"><span class="toc-number">8.2.</span> <span class="toc-text">Sentinel自定义降级异常数据开发实战</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sentinel整合OpenFeign配置实战"><span class="toc-number">8.3.</span> <span class="toc-text">Sentinel整合OpenFeign配置实战</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#AlibabaCloud微服务升级下一代-JDK11-LTS长期支持版本"><span class="toc-number">9.</span> <span class="toc-text">AlibabaCloud微服务升级下一代 JDK11 LTS长期支持版本</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#JDK各个版本常⻅问题"><span class="toc-number">9.1.</span> <span class="toc-text">JDK各个版本常⻅问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AlibabaCloud微服务升级JDK11和配置"><span class="toc-number">9.2.</span> <span class="toc-text">AlibabaCloud微服务升级JDK11和配置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#微服务核心组件之网关"><span class="toc-number">10.</span> <span class="toc-text">微服务核心组件之网关</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#微服务的网关和应用场景"><span class="toc-number">10.1.</span> <span class="toc-text">微服务的网关和应用场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#微服务的网关SpringCloud-Gateway介绍"><span class="toc-number">10.2.</span> <span class="toc-text">微服务的网关SpringCloud Gateway介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringCloud-Gateway项目创建和依赖添加"><span class="toc-number">10.3.</span> <span class="toc-text">SpringCloud Gateway项目创建和依赖添加</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringCloud-Gateway网关整合Nacos开发实战"><span class="toc-number">10.4.</span> <span class="toc-text">SpringCloud Gateway网关整合Nacos开发实战</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#网关Gateway架构-断言-过滤器进阶实战"><span class="toc-number">11.</span> <span class="toc-text">网关Gateway架构+断言+过滤器进阶实战</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringCloud-Gateway架构流程"><span class="toc-number">11.1.</span> <span class="toc-text">SpringCloud Gateway架构流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#微服务SpringCloud-Gateway内置路由断言"><span class="toc-number">11.2.</span> <span class="toc-text">微服务SpringCloud Gateway内置路由断言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Gateway内置断言实现接口定时下线实战"><span class="toc-number">11.3.</span> <span class="toc-text">Gateway内置断言实现接口定时下线实战</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringCloud-Gateway过滤器"><span class="toc-number">11.4.</span> <span class="toc-text">SpringCloud Gateway过滤器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#网关Gateway全局过滤器实现用户鉴权"><span class="toc-number">11.5.</span> <span class="toc-text">网关Gateway全局过滤器实现用户鉴权</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#AlibabaCloud微服务下的链路追踪系统实战"><span class="toc-number">12.</span> <span class="toc-text">AlibabaCloud微服务下的链路追踪系统实战</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#微服务架构下的排查问题复杂性概述"><span class="toc-number">12.1.</span> <span class="toc-text">微服务架构下的排查问题复杂性概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringCloud的链路追踪组件Sleuth实战"><span class="toc-number">12.2.</span> <span class="toc-text">SpringCloud的链路追踪组件Sleuth实战</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#微服务下的可视化链路追踪系统Zipkin实战"><span class="toc-number">12.3.</span> <span class="toc-text">微服务下的可视化链路追踪系统Zipkin实战</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#链路追踪组件Zipkin-Sleuth整合实战"><span class="toc-number">12.4.</span> <span class="toc-text">链路追踪组件Zipkin+Sleuth整合实战</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#微服务链路追踪系统Zipkin持久化配置"><span class="toc-number">12.5.</span> <span class="toc-text">微服务链路追踪系统Zipkin持久化配置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#AlibabaCloud微服务下的分布式配置中心实战"><span class="toc-number">13.</span> <span class="toc-text">AlibabaCloud微服务下的分布式配置中心实战</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#微服务下的分布式配置中心"><span class="toc-number">13.1.</span> <span class="toc-text">微服务下的分布式配置中心</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AlibabaCloud配置中心Nacos面板介绍"><span class="toc-number">13.2.</span> <span class="toc-text">AlibabaCloud配置中心Nacos面板介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AlibabaCloud配置中心Nacos动态配置下发实战"><span class="toc-number">13.3.</span> <span class="toc-text">AlibabaCloud配置中心Nacos动态配置下发实战</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#微服务容器化部署Docker"><span class="toc-number">14.</span> <span class="toc-text">微服务容器化部署Docker</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#阿里云Linux云服务器Centos-64位安装Docker实战"><span class="toc-number">14.1.</span> <span class="toc-text">阿里云Linux云服务器Centos 64位安装Docker实战</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#快速掌握-Docker仓库、镜像、容器核心概念"><span class="toc-number">14.2.</span> <span class="toc-text">快速掌握 Docker仓库、镜像、容器核心概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Docker容器常见命令实战"><span class="toc-number">14.3.</span> <span class="toc-text">Docker容器常见命令实战</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#容器化部署必备Docker公有-阿里云私有镜像仓库"><span class="toc-number">14.4.</span> <span class="toc-text">容器化部署必备Docker公有+阿里云私有镜像仓库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#不同系统Docker安装常见问题讲解和解决思路"><span class="toc-number">14.5.</span> <span class="toc-text">不同系统Docker安装常见问题讲解和解决思路</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#JDK11-AlibabaCloud-Docker整合打包镜像推送"><span class="toc-number">15.</span> <span class="toc-text">JDK11+AlibabaCloud+Docker整合打包镜像推送</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#镜像打包脚本Dockerfile介绍和【新版JDK11】整合"><span class="toc-number">15.1.</span> <span class="toc-text">镜像打包脚本Dockerfile介绍和【新版JDK11】整合</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AlibabaCloud-视频服务-订单服务Docker镜像打包"><span class="toc-number">15.2.</span> <span class="toc-text">AlibabaCloud-视频服务-订单服务Docker镜像打包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#本地镜像推送阿里云私有镜像仓库"><span class="toc-number">15.3.</span> <span class="toc-text">本地镜像推送阿里云私有镜像仓库</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#微服务公共组件在阿里云ECS容器化部署"><span class="toc-number">16.</span> <span class="toc-text">微服务公共组件在阿里云ECS容器化部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#部署实战-阿里云服务器Docker部署Nacos-镜像加速"><span class="toc-number">16.1.</span> <span class="toc-text">部署实战-阿里云服务器Docker部署Nacos+镜像加速</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#部署实战-阿里云ECS服务器Docker部署Sentinel"><span class="toc-number">16.2.</span> <span class="toc-text">部署实战-阿里云ECS服务器Docker部署Sentinel</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#部署实战-阿里云ECS服务器Docker部署Zipkin实战"><span class="toc-number">16.3.</span> <span class="toc-text">部署实战-阿里云ECS服务器Docker部署Zipkin实战</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#AlibabaCloud微服务阿里云ECS容器化部署"><span class="toc-number">17.</span> <span class="toc-text">AlibabaCloud微服务阿里云ECS容器化部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#配置文件Bug修复-网关重新打包推送"><span class="toc-number">17.1.</span> <span class="toc-text">配置文件Bug修复-网关重新打包推送</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#网关配置迁移阿里云Nacos配置中心和服务启动"><span class="toc-number">17.2.</span> <span class="toc-text">网关配置迁移阿里云Nacos配置中心和服务启动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#视频和订单服务迁移阿里云Nacos配置中心和镜像打包"><span class="toc-number">17.3.</span> <span class="toc-text">视频和订单服务迁移阿里云Nacos配置中心和镜像打包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#阿里云ECS服务器快速安装Mysql数据库"><span class="toc-number">17.4.</span> <span class="toc-text">阿里云ECS服务器快速安装Mysql数据库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AlibabaCloud视频和订单服务阿里云启动"><span class="toc-number">17.5.</span> <span class="toc-text">AlibabaCloud视频和订单服务阿里云启动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#微服务阿里云部署全链路验证和线上测试"><span class="toc-number">17.6.</span> <span class="toc-text">微服务阿里云部署全链路验证和线上测试</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Kaluna</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/lxy1866" target="_blank" rel="noopener">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">23</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">31</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">14</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://gitee.com/YuerryHUAHUA/figure/raw/master/img/20210521080208.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">嘿，走钢索的人</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/about">About</a><a class="site-page" href="/tags/">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">微服务全家桶 Alibaba Cloud+Docker容器化</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-04-29</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Alibaba-Cloud/">Alibaba Cloud</a><span class="post-meta__separator">|</span><i class="fa fa-comment-o post-meta__icon" aria-hidden="true"></i><a href="/2021/04/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%85%A8%E5%AE%B6%E6%A1%B6%20Alibaba%20Cloud+Docker%E5%AE%B9%E5%99%A8%E5%8C%96/#disqus_thread"><span class="disqus-comment-count" data-disqus-identifier="2021/04/29/微服务全家桶 Alibaba Cloud+Docker容器化/"></span></a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="微服务全家桶-Alibaba-Cloud-Docker容器化实战"><a href="#微服务全家桶-Alibaba-Cloud-Docker容器化实战" class="headerlink" title="微服务全家桶 Alibaba Cloud+Docker容器化实战"></a>微服务全家桶 Alibaba Cloud+Docker容器化实战</h1><h2 id="微服务AlibabaCloud-全家桶-Docker实战介绍"><a href="#微服务AlibabaCloud-全家桶-Docker实战介绍" class="headerlink" title="微服务AlibabaCloud 全家桶+Docker实战介绍"></a>微服务AlibabaCloud 全家桶+Docker实战介绍</h2><ul>
<li>基于小滴课堂在线教育架构拆分微服务，Maven聚合工程 + Mybatis操作数据库</li>
<li>零基础安装服务治理Nacos+AlibabaCloud服务连接</li>
<li>JDK11升级和里面的坑</li>
<li>深入源码：RPC 调用 Ribbon+负载均衡策略实现</li>
<li>Open-Feign组件+多种HTTP调用案例</li>
<li>CAP + BASE理论，注册中心架构选择</li>
<li>微服务容错组件Alibaba-Sentinel多种流控策略+熔断降级实操</li>
<li>SpringCloud-Gateway+多种路由断言+自定义全局鉴权过滤器</li>
<li>分布式链路追踪Zipkin+Sleuth实战 + Mysql数据持久</li>
<li>分布式配置中心Nacos实战+动态配置下发</li>
<li>Docker容器在阿里云ECS服务器安装+私有镜像仓库搭建</li>
<li>阿里云Docker部署Dockerfile+JDK11+AlibabaCloud全家桶镜像构建推送</li>
<li>阿里云Docker部署Sentinel+Nacos+Zipkin+Gateway +AlibabaCloud全家桶</li>
</ul>
<h2 id="学习目的"><a href="#学习目的" class="headerlink" title="学习目的"></a>学习目的</h2><p>互联网公司业务多数是微服务架构，可以快速实现扩容，独立部署，故障和资源的隔离性等等</p>
<h2 id="技术栈和环境说明"><a href="#技术栈和环境说明" class="headerlink" title="技术栈和环境说明"></a>技术栈和环境说明</h2><ul>
<li>SpringBoot.2.3.3 + Mybatis+ SpringCloud Hoxton.SR8+ AlibabaCloud 2.2.1</li>
<li>JDK8 + JDK11 + IDEA旗舰版 + Docker1.13 + 阿里云CentOS7.X</li>
</ul>
<h1 id="分布式架构核心知识"><a href="#分布式架构核心知识" class="headerlink" title="分布式架构核心知识"></a>分布式架构核心知识</h1><h2 id="分布式架构"><a href="#分布式架构" class="headerlink" title="分布式架构"></a>分布式架构</h2><ul>
<li><p>SOA ：Service Oriented Architecture 面向服务的架构 其中包含多个服务， 服务之间通过相互依赖最终提供一系列的功能, 一个服务通常以独立的形式存在于操作系统进程中, 各个服务之间通过网络调用。</p>
</li>
<li><p>将一个大的单体应用进行细粒度的服务化拆分，每个拆分出来的服务各自独立打包部署，各个服务之间通过网络调用。</p>
</li>
<li><p>优点</p>
<ul>
<li>易开发、理解和维护</li>
<li>独立的部署和启动</li>
</ul>
</li>
<li><p>缺点</p>
<ul>
<li>分布式系统-》分布式事务问题</li>
<li>需要管理多个服务-》服务治理</li>
</ul>
<p><img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/image-20200907171629762.png" alt="image-20200907171629762"></p>
</li>
</ul>
<h2 id="微服务全家桶架构组成"><a href="#微服务全家桶架构组成" class="headerlink" title="微服务全家桶架构组成"></a>微服务全家桶架构组成</h2><p>常见组件</p>
<ul>
<li><p>网关：路由转发 + 过滤器</p>
<ul>
<li>/api/v1/video/ 视频服务</li>
<li>/api/v1/order/ 订单服务</li>
<li>/api/v1/user/ 用户服务</li>
</ul>
</li>
<li><p>服务发现注册：调用和被调用方的信息维护</p>
</li>
<li><p>配置中心：管理配置，动态更新 application.properties </p>
</li>
<li><p>链路追踪：分析调用链路耗时，例子：下单-》查询商品服务获取商品价格-》查询用户信息-》保存数据库</p>
</li>
<li><p>负载均衡器：分发流量到多个节点，降低压力</p>
</li>
<li><p>熔断：保护自己和被调用方</p>
</li>
</ul>
<h2 id="业界微服务架构常见解决方案"><a href="#业界微服务架构常见解决方案" class="headerlink" title="业界微服务架构常见解决方案"></a>业界微服务架构常见解决方案</h2><ul>
<li><p>ServiceComb</p>
<ul>
<li>华为内部的CSE(Cloud Service Engine)框架开源, 一个微服务的开源解决方案,社区相对于下面几个比较小</li>
<li>文档不多，通信领域比较强</li>
</ul>
</li>
<li><p>dubbo</p>
<ul>
<li>zookeeper + dubbo + springmvc/springboot</li>
<li>官方地址：<a href="http://dubbo.apache.org/#!/?lang=zh-cn" target="_blank" rel="noopener">http://dubbo.apache.org/#!/?lang=zh-cn</a></li>
<li>配套<ul>
<li>通信方式：rpc</li>
<li>注册中心：zookeper/redis/nacos</li>
<li>配置中心：diamond、nacos</li>
</ul>
</li>
</ul>
</li>
<li><p>SpringCloud</p>
<ul>
<li>全家桶+轻松嵌入第三方组件(Netflix 奈飞)</li>
<li>官网：<a href="https://spring.io/projects/spring-cloud" target="_blank" rel="noopener">https://spring.io/projects/spring-cloud</a></li>
<li>配套<ul>
<li>通信方式：http restful</li>
<li>注册中心：eruka</li>
<li>配置中心：config</li>
<li>断路器（熔断降级）：hystrix</li>
<li>网关：zuul/gateway</li>
<li>分布式追踪系统：sleuth+zipkin</li>
</ul>
</li>
</ul>
</li>
<li><p>Spring Alibaba Cloud</p>
<ul>
<li>全家桶+阿里生态多个组件组合+SpringCloud支持</li>
<li>官网 <a href="https://spring.io/projects/spring-cloud-alibaba" target="_blank" rel="noopener">https://spring.io/projects/spring-cloud-alibaba</a></li>
<li>配套<ul>
<li>通信方式：http restful</li>
<li>注册中心：nacos</li>
<li>配置中心：nacos</li>
<li>断路器（熔断降级）：sentinel</li>
<li>网关：gateway</li>
<li>分布式追踪系统：sleuth+zipkin</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="AlibabaCloud核心组件介绍"><a href="#AlibabaCloud核心组件介绍" class="headerlink" title="AlibabaCloud核心组件介绍"></a><strong>AlibabaCloud核心组件介绍</strong></h2><p>官网介绍</p>
<ul>
<li><a href="https://spring.io/projects/spring-cloud-alibaba#overview" target="_blank" rel="noopener">https://spring.io/projects/spring-cloud-alibaba#overview</a></li>
</ul>
<p>为什么要选择AlibabaCloud , 和SpringCloud的区别？</p>
<ul>
<li><p>SpringCloud和AlibabaCloud组件存在很大交集，互相配合</p>
</li>
<li><p>SpringCloud很多组件是基于第三方整合，目前多个已经不更新了，比如zuul、eureka、hystrix等</p>
</li>
<li><p>AlibabaCloud 提供一站式微服务解决方法，已经和SpringCloud进行了整合，组件互相支持</p>
</li>
</ul>
<p>AlibabaCloud全家桶介绍</p>
<ul>
<li><a href="https://github.com/alibaba/spring-cloud-alibaba" target="_blank" rel="noopener">https://github.com/alibaba/spring-cloud-alibaba</a></li>
<li>服务注册发现：Nacos</li>
<li>服务限流降级：Sentinel</li>
<li>分布配置中心：Nacos</li>
<li>服务网关：SpringCloud Gateway</li>
<li>服务之间调用：Feign、Ribbon</li>
<li>链路追踪：Sleuth+Zipkin</li>
</ul>
<p>版本说明</p>
<ul>
<li>【注意文档：】官方经常改地址，如果本课程的地址失效后重新搜索下找入口</li>
<li>Spring5以上</li>
<li>SpringBoot2.x以上</li>
<li>AlibabaCloud 版本 2.2.x <a href="https://spring.io/projects/spring-cloud-alibaba#learn" target="_blank" rel="noopener">https://spring.io/projects/spring-cloud-alibaba#learn</a></li>
<li>SpirngCloud版本 Hoxton <a href="https://spring.io/projects/spring-cloud" target="_blank" rel="noopener">https://spring.io/projects/spring-cloud</a></li>
</ul>
<table>
<thead>
<tr>
<th align="left">Release Train</th>
<th align="left">Boot Version</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Hoxton</td>
<td align="left">2.2.x, 2.3.x (Starting with SR5)</td>
</tr>
<tr>
<td align="left">Greenwich</td>
<td align="left">2.1.x</td>
</tr>
<tr>
<td align="left">Finchley</td>
<td align="left">2.0.x</td>
</tr>
<tr>
<td align="left">Edgware</td>
<td align="left">1.5.x</td>
</tr>
<tr>
<td align="left">Dalston</td>
<td align="left">1.5.x</td>
</tr>
</tbody></table>
<h2 id="在线教育环微服务模块划分和环境准备"><a href="#在线教育环微服务模块划分和环境准备" class="headerlink" title="在线教育环微服务模块划分和环境准备"></a><strong>在线教育环微服务模块划分和环境准备</strong></h2><ul>
<li><p>在线教育模块划分</p>
<ul>
<li>视频服务</li>
<li>订单服务</li>
<li>用户服务</li>
</ul>
</li>
<li><p>必备基础环境：JDK8以上版本+Maven3.5(采用默认)+IDEA旗舰版+Mysql5.7以上版本</p>
</li>
<li><p>操作系统：Linux Centos7 64位(虚拟机) 或者 Mac苹果系统</p>
<ul>
<li>虚拟机可以搜索博文</li>
<li>Windows有些软件会不兼容，且坑难排查</li>
<li>学习期间务必关闭防火墙</li>
</ul>
</li>
</ul>
<h2 id="小滴课堂在线教育数据库表介绍和导入"><a href="#小滴课堂在线教育数据库表介绍和导入" class="headerlink" title="小滴课堂在线教育数据库表介绍和导入"></a><strong>小滴课堂在线教育数据库表介绍和导入</strong></h2><ul>
<li><p>采用3个数据库，每个服务单独一个库</p>
</li>
<li><p>视频服务数据库 video表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`video`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`title`</span> <span class="built_in">varchar</span>(<span class="number">524</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'视频标题'</span>,</span><br><span class="line">  <span class="string">`summary`</span> <span class="built_in">varchar</span>(<span class="number">1026</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'概述'</span>,</span><br><span class="line">  <span class="string">`cover_img`</span> <span class="built_in">varchar</span>(<span class="number">524</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'封面图'</span>,</span><br><span class="line">  <span class="string">`price`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'价格,分'</span>,</span><br><span class="line">  <span class="string">`create_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">  <span class="string">`point`</span> <span class="keyword">double</span>(<span class="number">11</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="string">'8.70'</span> <span class="keyword">COMMENT</span> <span class="string">'默认8.7，最高10分'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">48</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`video`</span> (<span class="string">`id`</span>, <span class="string">`title`</span>, <span class="string">`summary`</span>, <span class="string">`cover_img`</span>, <span class="string">`price`</span>, <span class="string">`create_time`</span>, <span class="string">`point`</span>)</span><br><span class="line"><span class="keyword">VALUES</span></span><br><span class="line">  (<span class="number">30</span>, <span class="string">'互联网架构之JAVA虚拟机JVM零基础到高级实战'</span>, <span class="string">'https://xdvideo-file.oss-cn-shenzhen.aliyuncs.com/video/2020/maven/%E8%AF%A6%E6%83%85%E5%9B%BE.png'</span>, <span class="string">'https://xdvideo-file.oss-cn-shenzhen.aliyuncs.com/video/2020/maven/%E5%AE%98%E7%BD%91%E4%B8%BB%E5%9B%BE-mawen.png'</span>, <span class="number">3980</span>, <span class="string">'2021-06-24 22:14:00'</span>, <span class="number">9.10</span>),</span><br><span class="line">  (<span class="number">40</span>, <span class="string">'全新微信小程序零基础到项目实战'</span>, <span class="string">'https://xdvideo-file.oss-cn-shenzhen.aliyuncs.com/video/2020/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/%E8%AF%A6%E6%83%85%E5%9B%BE.png'</span>, <span class="string">'https://xdvideo-file.oss-cn-shenzhen.aliyuncs.com/video/2020/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/%E5%AE%98%E7%BD%91%E4%B8%BB%E5%9B%BE-%E5%B0%8F%E7%A8%8B%E5%BA%8F.png'</span>, <span class="number">5980</span>, <span class="string">'2021-01-18 22:14:00'</span>, <span class="number">9.10</span>),</span><br><span class="line">  (<span class="number">41</span>, <span class="string">'玩转搜索框架ElasticSearch7.x实战'</span>, <span class="string">'https://xd-video-pc-img.oss-cn-beijing.aliyuncs.com/xdclass_pro/video/2019_backend/elasticsearch7_detail.jpeg'</span>, <span class="string">'https://xd-video-pc-img.oss-cn-beijing.aliyuncs.com/xdclass_pro/video/2019_backend/elasticsearch7.png'</span>, <span class="number">4880</span>, <span class="string">'2021-01-10 22:14:00'</span>, <span class="number">8.70</span>),</span><br><span class="line">  (<span class="number">45</span>, <span class="string">'Docker实战视频教程入门到高级dockerfile/compose-Harbor'</span>, <span class="string">'https://xdvideo-file.oss-cn-shenzhen.aliyuncs.com/video/2020/Docker/%E8%AF%A6%E6%83%85%E5%9B%BE.jpeg'</span>, <span class="string">'https://xdvideo-file.oss-cn-shenzhen.aliyuncs.com/video/2020/Docker/%E5%AE%98%E7%BD%91%E4%B8%BB%E5%9B%BE-docker.png'</span>, <span class="number">5980</span>, <span class="string">'2021-01-10 22:14:00'</span>, <span class="number">9.30</span>),</span><br><span class="line">  (<span class="number">46</span>, <span class="string">'新版javase零基础到高级教程小白自学编程'</span>, <span class="string">'https://xdvideo-file.oss-cn-shenzhen.aliyuncs.com/video/2020/%E6%96%B0%E7%89%88javase/%E8%AF%A6%E6%83%85%E5%9B%BE.png'</span>, <span class="string">'https://file.xdclass.net/video/2020/%E6%96%B0%E7%89%88javase/%E5%AE%98%E7%BD%91%E4%B8%BB%E5%9B%BE-javase.png'</span>, <span class="number">3980</span>, <span class="string">'2021-01-24 22:14:00'</span>, <span class="number">8.80</span>),</span><br><span class="line">  (<span class="number">47</span>, <span class="string">'Nodejs教程零基础入门到项目实战前端视频教程'</span>, <span class="string">'https://xdvideo-file.oss-cn-shenzhen.aliyuncs.com/video/2020/node/%E5%AE%98%E7%BD%91%E8%AF%A6%E6%83%85%E5%9B%BE-node.png'</span>, <span class="string">'https://xdvideo-file.oss-cn-shenzhen.aliyuncs.com/video/2020/node/%E5%AE%98%E7%BD%91%E4%B8%BB%E5%9B%BE-node.png'</span>, <span class="number">6980</span>, <span class="string">'2021-01-24 22:14:00'</span>, <span class="number">8.90</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>用户服务数据库 user表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`user`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`phone`</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`pwd`</span> <span class="built_in">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`sex`</span> <span class="built_in">int</span>(<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`img`</span> <span class="built_in">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`create_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`role`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'1是普通用户，2是管理员'</span>,</span><br><span class="line">  <span class="string">`username`</span> <span class="built_in">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`wechat`</span> <span class="built_in">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">5</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`user`</span> (<span class="string">`id`</span>, <span class="string">`phone`</span>, <span class="string">`pwd`</span>, <span class="string">`sex`</span>, <span class="string">`img`</span>, <span class="string">`create_time`</span>, <span class="string">`role`</span>, <span class="string">`username`</span>, <span class="string">`wechat`</span>)</span><br><span class="line"><span class="keyword">VALUES</span></span><br><span class="line">  (<span class="number">1</span>, <span class="string">'123'</span>, <span class="string">'666'</span>, <span class="number">1</span>, <span class="string">'xdclass.net'</span>, <span class="string">'2021-09-09 00:00:00'</span>, <span class="number">1</span>, <span class="string">'jack'</span>, <span class="string">'xdclass6'</span>),</span><br><span class="line">  (<span class="number">2</span>, <span class="string">'2323432'</span>, <span class="string">'794666918'</span>, <span class="number">1</span>, <span class="string">'wwwww'</span>, <span class="string">'2020-05-20 04:54:01'</span>, <span class="number">1</span>, <span class="string">'小滴Anna姐姐'</span>, <span class="string">'xdclass-anna'</span>),</span><br><span class="line">  (<span class="number">3</span>, <span class="string">'2323432'</span>, <span class="string">'xdclass-lw'</span>, <span class="number">1</span>, <span class="string">'wwwww'</span>, <span class="string">'2020-05-20 04:54:42'</span>, <span class="number">1</span>, <span class="string">'二当家小D'</span>, <span class="string">'xdclass1'</span>),</span><br><span class="line">  (<span class="number">4</span>, <span class="string">'2323432'</span>, <span class="string">'3232323'</span>, <span class="number">1</span>, <span class="string">'wwwww'</span>, <span class="string">'2020-05-20 04:55:07'</span>, <span class="number">1</span>, <span class="string">'老王'</span>, <span class="string">'xdclass-lw'</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>订单服务数据库video_order表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`video_order`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`out_trade_no`</span> <span class="built_in">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'订单唯一标识'</span>,</span><br><span class="line">  <span class="string">`state`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'0表示未支付，1表示已支付'</span>,</span><br><span class="line">  <span class="string">`create_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'订单生成时间'</span>,</span><br><span class="line">  <span class="string">`total_fee`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'支付金额，单位分'</span>,</span><br><span class="line">  <span class="string">`video_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'视频主键'</span>,</span><br><span class="line">  <span class="string">`video_title`</span> <span class="built_in">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'视频标题'</span>,</span><br><span class="line">  <span class="string">`video_img`</span> <span class="built_in">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'视频图片'</span>,</span><br><span class="line">  <span class="string">`user_id`</span> <span class="built_in">int</span>(<span class="number">12</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'用户id'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">42</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="Maven聚合工程创建微服务项目"><a href="#Maven聚合工程创建微服务项目" class="headerlink" title="Maven聚合工程创建微服务项目"></a>Maven聚合工程创建微服务项目</h2><ul>
<li><p>maven聚合工程</p>
<ul>
<li>xdclass-common</li>
<li>xdclass-video-service</li>
<li>xdclass-user-service</li>
<li>xdclass-order-service</li>
</ul>
</li>
<li><p>创建聚合工程（记得删除聚合工程src目录）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.xdclass<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-dmeo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">module</span>&gt;</span>xdclass-cloud-common<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">module</span>&gt;</span>xdclass-cloud-user<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">module</span>&gt;</span>xdclass-cloud-video<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">module</span>&gt;</span>xdclass-cloud-order<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- 一般来说父级项目的packaging都为pom，packaging默认类型jar类型--&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">           <span class="comment">&lt;!--https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-dependencies/2.3.3.RELEASE--&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="comment">&lt;!--https://mvnrepository.com/artifact/org.springframework.cloud/spring-cloud-dependencies/Hoxton.SR8--&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">version</span>&gt;</span>Hoxton.SR8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="comment">&lt;!--https://mvnrepository.com/artifact/com.alibaba.cloud/spring-cloud-alibaba-dependencies/2.2.1.RELEASE--&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">fork</span>&gt;</span>true<span class="tag">&lt;/<span class="name">fork</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">addResources</span>&gt;</span>true<span class="tag">&lt;/<span class="name">addResources</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建3个子项目</p>
</li>
<li><p>添加子项目依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.xdclass<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xdclass-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>注意: 有些包maven下载慢，等待下载如果失败</p>
<ul>
<li>删除本地仓库spring相关的包，重新执行 mvn install</li>
</ul>
</li>
</ul>
<h2 id="AlibabaCloud微服务Mybatis连接MySQL数据库"><a href="#AlibabaCloud微服务Mybatis连接MySQL数据库" class="headerlink" title="AlibabaCloud微服务Mybatis连接MySQL数据库"></a>AlibabaCloud微服务Mybatis连接MySQL数据库</h2><p><strong>微服务打通Mybatis连接MySQL数据库</strong></p>
<ul>
<li><p>创建common包实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> Integer id;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">        <span class="keyword">private</span> String pwd;</span><br><span class="line">        <span class="keyword">private</span> String headImg;</span><br><span class="line">        <span class="keyword">private</span> String phone;</span><br><span class="line">        <span class="keyword">private</span> Date createTime;</span><br><span class="line">        <span class="keyword">private</span> String wechat;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Video</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> String summary;</span><br><span class="line">    <span class="keyword">private</span> String coverImg;</span><br><span class="line">    <span class="keyword">private</span> Integer  price;</span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">    <span class="keyword">private</span> Double point;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoOrder</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String outTradeNo;</span><br><span class="line">    <span class="keyword">private</span> Integer state;</span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">    <span class="keyword">private</span>  Integer totalFee;</span><br><span class="line">    <span class="keyword">private</span> Integer videoId;</span><br><span class="line">    <span class="keyword">private</span> String videoTitle;</span><br><span class="line">    <span class="keyword">private</span> String videoImg;</span><br><span class="line">    <span class="keyword">private</span> Integer userId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Mybatis依赖导入+数据库配置</p>
<ul>
<li>xdclass-video-service</li>
<li>xdclass-user-service</li>
<li>xdclass-order-service</li>
</ul>
</li>
<li><p>聚合工程pom.xml修改【注意：添加在父pom.xml】</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>添加mybatis依赖和数据库驱动【注意：添加在子pom.xml，即三个modue的pom.xml中】</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>3个模块配置数据库连接（记得修改 端口、应用名称、数据库名称）</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9000</span> <span class="comment"># 不同服务这里的端口都是不一样的</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">xdclass-video-service</span> <span class="comment"># 每个服务的名字</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/cloud_video?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line"><span class="comment"># 控制台输出sql、下划线转驼峰</span></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">log-impl:</span> <span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br><span class="line">    <span class="attr">map-underscore-to-camel-case:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>controller-&gt;service-&gt;mapper 开发</p>
</li>
<li><p>application配置（在每个module的启动类添加）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan</span>(<span class="string">"net.xdclass.dao"</span>)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="微服务之间的调用-下单购买视频"><a href="#微服务之间的调用-下单购买视频" class="headerlink" title="微服务之间的调用-下单购买视频"></a>微服务之间的调用-下单购买视频</h2><p>服务直接怎么调用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;TODO</span><br><span class="line">RPC:</span><br><span class="line">  远程过程调用，像调用本地服务(方法)一样调用服务器的服务</span><br><span class="line">  支持同步、异步调用</span><br><span class="line">  客户端和服务器之间建立TCP连接，可以一次建立一个，也可以多个调用复用一次链接</span><br><span class="line">  RPC数据包小</span><br><span class="line">    protobuf</span><br><span class="line">    thrift</span><br><span class="line">  rpc：编解码，序列化，链接，丢包，协议</span><br><span class="line">  </span><br><span class="line">Rest(Http):</span><br><span class="line">  http请求，支持多种协议和功能</span><br><span class="line">  开发方便成本低</span><br><span class="line">  http数据包大</span><br><span class="line">  java开发：resttemplate或者httpclient</span><br></pre></td></tr></table></figure>

<p>用户下单</p>
<ul>
<li>订单服务-&gt;视频服务(查询价格和冗余信息)</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//放在订单服务的启动类中</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RestTemplate <span class="title">getRestTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//放在订单服务的controller层</span></span><br><span class="line">Video video = restTemplate.getForObject(<span class="string">"http://localhost:9000/api/v1/video/find_by_id?videoId="</span>+videoId,Video<span class="class">.<span class="keyword">class</span>)</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>存在的问题：<ul>
<li>服务之间的IP信息写死</li>
<li>服务之间无法提供负载均衡</li>
<li>多个服务直接关系调用维护复杂</li>
</ul>
</li>
</ul>
<h1 id="AlibabaCloud核心组件服务治理Nacos实战"><a href="#AlibabaCloud核心组件服务治理Nacos实战" class="headerlink" title="AlibabaCloud核心组件服务治理Nacos实战"></a>AlibabaCloud核心组件服务治理Nacos实战</h1><h2 id="什么是注册中心和常见的注册中心有哪些"><a href="#什么是注册中心和常见的注册中心有哪些" class="headerlink" title="什么是注册中心和常见的注册中心有哪些"></a><strong>什么是注册中心和常见的注册中心有哪些</strong></h2><ul>
<li><p>什么是注册中心（服务治理）</p>
<ul>
<li>服务注册：服务提供者provider，启动的时候向注册中心上报自己的网络信息<ul>
<li>服务发现：服务消费者consumer,启动的时候向注册中心上报自己的网络信息，拉取provider的相关网络信息</li>
</ul>
</li>
<li>核心:服务管理,是有个服务注册表，心跳机制动态维护，服务实例在启动时注册到服务注册表，并在关闭时注销。</li>
</ul>
</li>
<li><p>为什么要用</p>
<ul>
<li>微服务应用和机器越来越多，调用方需要知道接口的网络地址，如果靠配置文件的方式去控制网络地址，对于动态新增机器，维护带来很大问题</li>
</ul>
</li>
<li><p>主流的注册中心：zookeeper、Eureka、consul、etcd、Nacos</p>
<ul>
<li><p>AlibabaCloud搭配最好的是Nacos，且服务的注册发现之外，还支持动态配置服务</p>
</li>
<li><p>参考图片(nacos官网)</p>
<p><img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/nacosMap.png" alt="nacos_map"></p>
</li>
</ul>
</li>
</ul>
<h2 id="AlibabaCloud注册中心Nacos实战"><a href="#AlibabaCloud注册中心Nacos实战" class="headerlink" title="AlibabaCloud注册中心Nacos实战"></a>AlibabaCloud注册中心Nacos实战</h2><ul>
<li><p>官网：<a href="https://nacos.io/zh-cn/" target="_blank" rel="noopener">https://nacos.io/zh-cn/</a></p>
</li>
<li><p>Linux/Mac安装Nacos</p>
<ul>
<li>解压安装包</li>
<li>进入bin目录</li>
<li>启动 sh startup.sh -m standalone</li>
<li>访问 localhost:8848/nacos</li>
<li>默认账号密码 nacos/nacos</li>
</ul>
</li>
</ul>
<p><img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/image-20200907191606114.png" alt="image-20200907191606114"></p>
<h2 id="基于nacos实现订单-视频服务之间的调用"><a href="#基于nacos实现订单-视频服务之间的调用" class="headerlink" title="基于nacos实现订单-视频服务之间的调用"></a>基于nacos实现订单-视频服务之间的调用</h2><p>视频服务集成Nacos</p>
<ul>
<li><p>每个module添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--添加nacos客户端--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在每个module的application.yml中配置nacos地址</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9000</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">xdclass-video-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>每个module中的启动类增加注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>订单服务集成Nacos</p>
</li>
<li><p>用户服务集成Nacos</p>
</li>
<li><p>服务之间的调用</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line">   <span class="meta">@RequestMapping</span>(<span class="string">"save"</span>)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> VideoOrder <span class="title">save</span><span class="params">(<span class="keyword">int</span> videoId)</span></span>&#123;</span><br><span class="line">       </span><br><span class="line">       VideoOrder videoOrder = <span class="keyword">new</span> VideoOrder();</span><br><span class="line">       videoOrder.setVideoId(videoId);</span><br><span class="line">       </span><br><span class="line">       List&lt;ServiceInstance&gt; list = discoveryClient.getInstances(<span class="string">"xdclass-video-service"</span>);</span><br><span class="line">       ServiceInstance serviceInstance = list.get(<span class="number">0</span>);<span class="comment">//因为一个服务有可能有多个实例</span></span><br><span class="line"></span><br><span class="line">       Video video = restTemplate.getForObject(<span class="string">"http://"</span>+serviceInstance.getHost()+<span class="string">":"</span>+serviceInstance.getPort()+</span><br><span class="line">               <span class="string">"/api/v1/video/find_by_id?videoId="</span>+videoId,Video<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">       </span><br><span class="line">       videoOrder.setVideoTitle(video.getTitle());</span><br><span class="line">       videoOrder.setVideoId(video.getId());</span><br><span class="line">       <span class="keyword">return</span> videoOrder;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h2 id="常见的负载均衡策略和解决方案"><a href="#常见的负载均衡策略和解决方案" class="headerlink" title="常见的负载均衡策略和解决方案"></a>常见的负载均衡策略和解决方案</h2><p>什么是负载均衡（Load Balance）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">分布式系统中一个非常重要的概念，当访问的服务具有多个实例时，需要根据某种“均衡”的策略决定请求发往哪个节点，这就是所谓的负载均衡，</span><br><span class="line">原理是将数据流量分摊到多个服务器执行，减轻每台服务器的压力，从而提高了数据的吞吐量</span><br></pre></td></tr></table></figure>

<p>软硬件角度负载均衡的种类</p>
<ul>
<li>通过硬件来进行解决，常见的硬件有NetScaler、F5、Radware和Array等商用的负载均衡器，但比较昂贵的</li>
<li>通过软件来进行解决，常见的软件有LVS、Nginx等,它们是基于Linux系统并且开源的负载均衡策略</li>
</ul>
<p>从端的角度负载均衡有两种</p>
<ul>
<li>服务端负载均衡</li>
<li>客户端负载均衡</li>
</ul>
<img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/image-20200908114732828.png" alt="image-20200908114732828" style="zoom:67%;" />

<p>常见的负载均衡策略（看组件的支持情况）</p>
<ul>
<li><p>节点轮询</p>
<ul>
<li>简介：每个请求按顺序分配到不同的后端服务器</li>
</ul>
</li>
<li><p>weight 权重配置</p>
<ul>
<li>简介：weight和访问比率成正比，数字越大，分配得到的流量越高</li>
</ul>
</li>
<li><p>固定分发</p>
<ul>
<li>简介：根据请求按访问ip的hash结果分配，这样每个用户就可以固定访问一个后端服务器</li>
</ul>
</li>
<li><p>随机选择、最短响应时间等等</p>
</li>
</ul>
<h2 id="AlibabaCloud集成Ribbon实现负载均衡"><a href="#AlibabaCloud集成Ribbon实现负载均衡" class="headerlink" title="AlibabaCloud集成Ribbon实现负载均衡"></a>AlibabaCloud集成Ribbon实现负载均衡</h2><ul>
<li><p>什么是Ribbon？</p>
<p>Ribbon是一个<strong>客户端负载均衡工具</strong>，通过Spring Cloud封装，可以轻松和AlibabaCloud整合</p>
</li>
<li><p>订单服务增加 @LoadBalanced 注解</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@LoadBalanced</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用实战</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Video video = restTemplate.getForObject(<span class="string">"http://xdclass-video-service/api/v1/video/find_by_id?videoId="</span>+videoId, Video<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//注意：方便大家看到负载均衡效果，在video类增加这个字段，记录当前机器ip+端口</span></span><br></pre></td></tr></table></figure>

<h1 id="负载均衡进阶之Ribbon和Feign实战-源码分析"><a href="#负载均衡进阶之Ribbon和Feign实战-源码分析" class="headerlink" title="负载均衡进阶之Ribbon和Feign实战+源码分析"></a>负载均衡进阶之Ribbon和Feign实战+源码分析</h1><h2 id="ribbon服务间调用负载均衡源码分析"><a href="#ribbon服务间调用负载均衡源码分析" class="headerlink" title="ribbon服务间调用负载均衡源码分析"></a>ribbon服务间调用负载均衡源码分析</h2><ul>
<li><p>源码分析思路</p>
<ul>
<li>通过直接找入口</li>
</ul>
</li>
<li><p>分析@LoadBalanced </p>
<ol>
<li><p>首先从注册中心获取provider的列表 </p>
</li>
<li><p>通过一定的策略选择其中一个节点</p>
</li>
<li><p>再返回给restTemplate调用</p>
</li>
</ol>
<p><img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/image-20200908120918173.png" alt="image-20200908120918173"></p>
<img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/image-20200908121025809.png" alt="image-20200908121025809" style="zoom:200%;" />

<p><img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/image-20200908121944720.png" alt="image-20200908121944720"></p>
<p><img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/image-20200908122031575.png" alt="image-20200908122031575"></p>
<p><img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/image-20200908123805156.png" alt="image-20200908123805156"></p>
</li>
</ul>
<h2 id="AlibabaCloud负载均衡策略调整实战"><a href="#AlibabaCloud负载均衡策略调整实战" class="headerlink" title="AlibabaCloud负载均衡策略调整实战"></a>AlibabaCloud负载均衡策略调整实战</h2><ul>
<li><p>源码分析知道ribbon支持多种负载均衡策略</p>
<p><img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/image-20200908124142724.png" alt="image-20200908124142724"></p>
</li>
<li><p>Ribbon支持的负载均衡策略介绍</p>
<table>
<thead>
<tr>
<th>策略类</th>
<th>命名</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>RandomRule</td>
<td>随机策略</td>
<td>随机选择server</td>
</tr>
<tr>
<td>RoundRobinRule</td>
<td>轮询策略</td>
<td>按照顺序选择server（默认）</td>
</tr>
<tr>
<td>RetryRule</td>
<td>重试策略</td>
<td>当选择server不成功，短期内尝试选择一个可用的server</td>
</tr>
<tr>
<td>AvailabilityFilteringRule</td>
<td>可用过滤策略</td>
<td>过滤掉一直失败并被标记为circuit tripped的server，过滤掉那些高并发链接的server（active connections超过配置的阈值）</td>
</tr>
<tr>
<td>WeightedResponseTimeRule</td>
<td>响应时间加权重策略</td>
<td>根据server的响应时间分配权重，以响应时间作为权重，响应时间越短的服务器被选中的概率越大，综合了各种因素，比如：网络，磁盘，io等，都直接影响响应时间</td>
</tr>
<tr>
<td>ZoneAvoidanceRule</td>
<td>区域权重策略</td>
<td>综合判断server所在区域的性能，和server的可用性，轮询选择server</td>
</tr>
</tbody></table>
</li>
<li><p>负载均衡策略调整实战</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 订单服务增加配置</span></span><br><span class="line"><span class="attr">xdclass-video-service:</span></span><br><span class="line">  <span class="attr">ribbon:</span></span><br><span class="line">    <span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.netflix.loadbalancer.RandomRule</span></span><br></pre></td></tr></table></figure>

<p><img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/image-20200908125342233.png" alt="image-20200908125342233"></p>
</li>
</ul>
<p>策略选择</p>
<ol>
<li>如果每个机器配置一样，则建议不修改策略 (推荐)</li>
<li>如果部分机器配置强，则可以改为 WeightedResponseTimeRule</li>
</ol>
<h2 id="负载均衡组件Open-Feign介绍"><a href="#负载均衡组件Open-Feign介绍" class="headerlink" title="负载均衡组件Open-Feign介绍"></a>负载均衡组件Open-Feign介绍</h2><ul>
<li><p>原先ribbon代码存在的问题：不规范，风格不统一，维护性比较差</p>
</li>
<li><p>什么是Feign</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SpringCloud提供的伪http客户端(本质还是用http)，封装了Http调用流程，更适合面向接口化</span><br><span class="line">用Java接口注解的方式调用Http请求.</span><br><span class="line">不用像Ribbon中通过封装HTTP请求报文的方式调用</span><br><span class="line">Feign默认集成了Ribbon</span><br></pre></td></tr></table></figure>
</li>
<li><p>官方文档</p>
<ul>
<li><a href="https://spring.io/projects/spring-cloud-openfeign" target="_blank" rel="noopener">https://spring.io/projects/spring-cloud-openfeign</a></li>
<li>版本 2.2.5</li>
</ul>
</li>
<li><p>Nacos支持Feign,可以直接集成实现负载均衡的效果</p>
</li>
</ul>
<h2 id="改造微服务-集成Open-Feign实现远程方法调用"><a href="#改造微服务-集成Open-Feign实现远程方法调用" class="headerlink" title="改造微服务 集成Open-Feign实现远程方法调用"></a>改造微服务 集成Open-Feign实现远程方法调用</h2><ul>
<li><p>Feign让方法调用更加解耦</p>
</li>
<li><p>使用feign步骤讲解</p>
<ul>
<li><p>每个服务都加入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置注解，启动类增加</p>
<p>@EnableFeignClients</p>
</li>
<li><p>增加一个接口</p>
<p>订单服务增加接口，服务名称记得和nacos保持一样</p>
<p>只需要添加在service层，没有service实现类</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> net.xdclass.Service;</span><br><span class="line"></span><br><span class="line"><span class="comment">//服务名称记得和nacos保持一样</span></span><br><span class="line"><span class="meta">@FeignClient</span>(value = <span class="string">"xdclass-video-service"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">VideoService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/api/v1/video/save"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">save</span><span class="params">(@RequestBody Video video)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/api/v1/video/find_by_id"</span>)</span><br><span class="line">    <span class="function">Video <span class="title">findById</span><span class="params">(@RequestParam(<span class="string">"videoId"</span>)</span> <span class="keyword">int</span> videoId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>换用不同端口，开启多个视频服务，在nacos中可以发现多个视频服务，用postman发送请求可以看出open-feign的效果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在videoOrder中添加字段serverInfo，通过这个字段我们就能够在postman中查看端口号</span></span><br><span class="line">videoOrder.setServerInfo(video.getServeInfo());</span><br></pre></td></tr></table></figure>
</li>
<li><p>Ribbon和feign两个的区别和选择</p>
<p>选择feign<br>默认集成了ribbon<br>写起来更加思路清晰和方便<br>采用注解方式进行配置，配置熔断等方式方便</p>
</li>
</ul>
<h1 id="不可不知道的分布式架构理论"><a href="#不可不知道的分布式架构理论" class="headerlink" title="不可不知道的分布式架构理论"></a>不可不知道的分布式架构理论</h1><h2 id="分布式应用核心CAP知识"><a href="#分布式应用核心CAP知识" class="headerlink" title="分布式应用核心CAP知识"></a>分布式应用核心CAP知识</h2><p>CAP定理: 指的是在一个分布式系统中，Consistency（一致性）、 Availability（可用性）、Partition tolerance（分区容错性），三者不可同时获得</p>
<ul>
<li>一致性（C）：所有节点都可以访问到最新的数据</li>
<li>可用性（A）：每个请求都是可以得到响应的，不管请求是成功还是失败</li>
<li>分区容错性（P）：除了全部整体网络故障，其他故障都不能导致整个系统不可用</li>
</ul>
<p>CAP理论就是说在分布式存储系统中，最多只能实现上面的两点。而由于当前的网络硬件肯定会出现延迟丢包等问题，所以分区容忍性是我们必须需要实现的。所以我们只能在一致性和可用性之间进行权衡。</p>
<p><img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/285763-20190621144256061-464757033.png" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CA： 如果不要求P（不允许分区），则C（强一致性）和A（可用性）是可以保证的。但放弃P的同时也就意味着放弃了系统的扩展性，也就是分布式节点受限，没办法部署子节点，这是违背分布式系统设计的初衷的</span><br><span class="line"></span><br><span class="line">CP: 如果不要求A（可用），每个请求都需要在服务器之间保持强一致，而P（分区）会导致同步时间无限延长(也就是等待数据同步完才能正常访问服务)，一旦发生网络故障或者消息丢失等情况，就要牺牲用户的体验，等待所有数据全部一致了之后再让用户访问系统</span><br><span class="line"></span><br><span class="line">AP：要高可用并允许分区，则需放弃一致性。一旦分区发生，节点之间可能会失去联系，为了高可用，每个节点只能用本地数据提供服务，而这样会导致全局数据的不一致性。</span><br></pre></td></tr></table></figure>

<h2 id="CAP里面下的注册中心选择思考"><a href="#CAP里面下的注册中心选择思考" class="headerlink" title="CAP里面下的注册中心选择思考"></a>CAP里面下的注册中心选择思考</h2><ul>
<li>常见注册中心：zk、eureka、nacos</li>
<li>那你应该怎么选择</li>
</ul>
<table>
<thead>
<tr>
<th align="left"></th>
<th align="left"><strong>Nacos</strong></th>
<th align="left"><strong>Eureka</strong></th>
<th align="left"><strong>Consul</strong></th>
<th align="left"><strong>Zookeeper</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">一致性协议</td>
<td align="left">CP+AP</td>
<td align="left">AP</td>
<td align="left">CP</td>
<td align="left">CP</td>
</tr>
<tr>
<td align="left">健康检查</td>
<td align="left">TCP/HTTP/MYSQL/Client Beat</td>
<td align="left">心跳</td>
<td align="left">TCP/HTTP/gRPC/Cmd</td>
<td align="left">Keep Alive</td>
</tr>
<tr>
<td align="left">雪崩保护</td>
<td align="left">有</td>
<td align="left">有</td>
<td align="left">无</td>
<td align="left">无</td>
</tr>
<tr>
<td align="left">访问协议</td>
<td align="left">HTTP/DNS</td>
<td align="left">HTTP</td>
<td align="left">HTTP/DNS</td>
<td align="left">TCP</td>
</tr>
<tr>
<td align="left">SpringCloud集成</td>
<td align="left">支持</td>
<td align="left">支持</td>
<td align="left">支持</td>
<td align="left">支持</td>
</tr>
</tbody></table>
<ul>
<li><p>Zookeeper：CP设计，保证了一致性，集群搭建的时候，某个节点失效，则会进行选举行的leader，或者半数以上节点不可用，则无法提供服务，因此可用性没法满足</p>
</li>
<li><p>Eureka：AP原则，无主从节点，一个节点挂了，自动切换其他节点可以使用，去中心化</p>
</li>
<li><p>结论：</p>
<ul>
<li>分布式系统中P,肯定要满足，所以只能在CA中二选一</li>
<li>没有最好的选择，最好的选择是根据业务场景来进行架构设计</li>
<li>如果要求一致性，则选择zookeeper/Nacos，如金融行业 CP</li>
<li>如果要求可用性，则Eureka/Nacos，如电商系统 AP</li>
<li>CP：适合支付、交易类，要求数据强一致性，宁可业务不可用，也不能出现脏数据</li>
<li>AP：互联网业务，比如信息流架构，不要求数据强一致，更想要服务可用</li>
</ul>
</li>
</ul>
<h2 id="一致性和可用性的权衡结果-BASE理论"><a href="#一致性和可用性的权衡结果-BASE理论" class="headerlink" title="一致性和可用性的权衡结果 BASE理论"></a>一致性和可用性的权衡结果 BASE理论</h2><ul>
<li><p>什么是Base理论</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CAP 中的一致性和可用性进行一个权衡的结果，核心思想就是：我们无法做到强一致，但每个应用都可以根据自身的业务特点，采用适当的方式来使系统达到最终一致性, 来自 ebay 的架构师提出</span><br></pre></td></tr></table></figure>
</li>
<li><p>Basically Available(基本可用)</p>
<ul>
<li>假设系统，出现了不可预知的故障，但还是能用, 可能会有性能或者功能上的影响</li>
</ul>
</li>
<li><p>Soft state（软状态）</p>
<ul>
<li>允许系统中的数据存在中间状态，并认为该状态不影响系统的整体可用性，即允许系统在多个不同节点的数据副本存在数据延时</li>
</ul>
</li>
<li><p>Eventually consistent（最终一致性）</p>
<ul>
<li>系统能够保证在没有其他新的更新操作的情况下，数据最终一定能够达到一致的状态，因此所有客户端对系统的数据访问最终都能够获取到最新的值</li>
</ul>
</li>
</ul>
<h1 id="高并发下的微服务架构存在的问题和解决方案"><a href="#高并发下的微服务架构存在的问题和解决方案" class="headerlink" title="高并发下的微服务架构存在的问题和解决方案"></a>高并发下的微服务架构存在的问题和解决方案</h1><p>高并发下存在的问题</p>
<ul>
<li><p>微服务拆分多个系统，服务之间互相依赖，可能会由于系统负载过高，突发流量或者网络等各种异常情况 导致服务不可用。</p>
</li>
<li><p>核心思想-面向失败编程</p>
<ul>
<li>不要外界影响</li>
<li>不被请求拖垮<ul>
<li>上游服务</li>
<li>下游服务</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="面向失败编程-微服务架构容错方案介绍"><a href="#面向失败编程-微服务架构容错方案介绍" class="headerlink" title="面向失败编程-微服务架构容错方案介绍"></a>面向失败编程-微服务架构容错方案介绍</h2><ul>
<li><p>限流</p>
<ul>
<li>如漏斗，不管流量多大，均匀的流入容器，令牌桶算法，漏桶算法</li>
</ul>
</li>
<li><p>熔断：</p>
<ul>
<li>保险丝，熔断服务，为了防止整个系统故障，包含当前和下游服务 下单服务 -》商品服务-》用户服务 -》（出现异常-》熔断风控服务</li>
</ul>
</li>
<li><p>降级：</p>
<ul>
<li>抛弃一些非核心的接口和数据，返回兜底数据 旅行箱的例子：只带核心的物品，抛弃非核心的，等有条件的时候再去携带这些物品</li>
</ul>
</li>
<li><p>隔离：</p>
<ul>
<li>服务和资源互相隔离，比如网络资源，机器资源，线程资源等，不会因为某个服务的资源不足而抢占其他服务的资源</li>
</ul>
</li>
<li><p>熔断和降级互相交集</p>
<ul>
<li>相同点：<ul>
<li>从可用性和可靠性触发，为了防止系统崩溃</li>
<li>最终让用户体验到的是某些功能暂时不能用</li>
</ul>
</li>
<li>不同点<ul>
<li>服务熔断一般是下游服务故障导致的，而服务降级一般是从整体系统负荷考虑，由调用方控制</li>
</ul>
</li>
</ul>
</li>
<li><p>想进行微服务的容错，业界目前有Sentinel、Hystrix，相对于AlibabaCloud而言，Sentinel是最好的搭配</p>
</li>
</ul>
<h2 id="分布式系统的流量防卫兵-Sentinel介绍"><a href="#分布式系统的流量防卫兵-Sentinel介绍" class="headerlink" title="分布式系统的流量防卫兵-Sentinel介绍"></a>分布式系统的流量防卫兵-Sentinel介绍</h2><ul>
<li>什么是Sentinel<ul>
<li>阿里巴巴开源的分布式系统流控工具</li>
<li>以流量为切入点，从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性</li>
<li>丰富的应用场景：消息削峰填谷、集群流量控制、实时熔断下游不可用应用等</li>
<li>完备的实时监控：Sentinel 同时提供实时的监控功能</li>
<li>提供开箱即用的与其它开源框架/库的整合模块，例如与 Spring Cloud、Dubbo、gRPC 的整合</li>
</ul>
</li>
<li>官网：<a href="https://github.com/alibaba/Sentinel/wiki/介绍" target="_blank" rel="noopener">https://github.com/alibaba/Sentinel/wiki/%E4%BB%8B%E7%BB%8D</a></li>
<li>Sentinel版本：2.2.1</li>
<li>核心概念：<ul>
<li>资源：是 Sentinel 中的核心概念之一，可以是java程序中任何内容，可以是服务或者方法甚至代码，总结起来就是我们要保护的东西</li>
<li>规则：定义怎样的方式保护资源，主要包括流控规则、熔断降级规则等</li>
</ul>
</li>
</ul>
<p><img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/50505538-2c484880-0aaf-11e9-9ffc-cbaaef20be2b.png" alt="Sentinel-features-overview"></p>
<h2 id="流量防卫兵-Sentinel依赖引入和控制台搭建"><a href="#流量防卫兵-Sentinel依赖引入和控制台搭建" class="headerlink" title="流量防卫兵-Sentinel依赖引入和控制台搭建"></a>流量防卫兵-Sentinel依赖引入和控制台搭建</h2><ul>
<li><p>Sentinel 分为两个部分</p>
<ul>
<li>核心库（Java 客户端）不依赖任何框架/库，能够运行于所有 Java 运行时环境，同时对 Dubbo、Spring Cloud 等框架也有较好的支持。</li>
<li>控制台（Dashboard）基于 Spring Boot 开发，打包后可以直接运行，不需要额外的 Tomcat 等应用容器。</li>
</ul>
</li>
<li><p>每个微服务都引入Sentinel依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Sentinel控制台搭建</p>
</li>
<li><p>文档：<a href="https://github.com/alibaba/Sentinel/wiki/控制台" target="_blank" rel="noopener">https://github.com/alibaba/Sentinel/wiki/控制台</a></p>
</li>
<li><p>控制台包含如下功能:</p>
<ul>
<li>查看机器列表以及健康情况：收集 Sentinel 客户端发送的心跳包，用于判断机器是否在线。</li>
<li>监控 (单机和集群聚合)通过 Sentinel 客户端暴露的监控 API，定期拉取并且聚合应用监控信息，最终可以实现秒级的实时监控。</li>
<li>规则管理和推送：统一管理推送规则。</li>
<li>鉴权：生产环境中鉴权非常重要。这里每个开发者需要根据自己的实际情况进行定制。</li>
</ul>
</li>
</ul>
<p><strong>注意：Sentinel 控制台目前仅支持单机部署</strong></p>
<p>启动 Sentinel 控制台需要 JDK 版本为 1.8 及以上版本，<br>-Dserver.port=8080 用于指定 Sentinel 控制台端口为 8080<br>默认用户名和密码都是 sentinel<br>sentinel-dashboard-1.8.0.jar：不同版本不同数字</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java <span class="literal">-Dserver</span>.port=<span class="number">8080</span> <span class="literal">-Dcsp</span>.sentinel.dashboard.server=localhost:<span class="number">8080</span> <span class="literal">-Dproject</span>.name=sentinel<span class="literal">-dashboard</span> <span class="literal">-jar</span> sentinel<span class="literal">-dashboard</span><span class="literal">-1</span>.<span class="number">8.0</span>.jar</span><br></pre></td></tr></table></figure>

<p><img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/image-20200908195822102.png" alt="image-20200908195822102"></p>
<h2 id="AliababCloud微服务整合Sentinel限流配置实战"><a href="#AliababCloud微服务整合Sentinel限流配置实战" class="headerlink" title="AliababCloud微服务整合Sentinel限流配置实战"></a>AliababCloud微服务整合Sentinel限流配置实战</h2><ul>
<li>多个微服务接入Sentinel配置</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8080</span> </span><br><span class="line">        <span class="attr">port:</span> <span class="number">9999</span> </span><br><span class="line"><span class="comment">#dashboard: 8080 控制台端口</span></span><br><span class="line"><span class="comment">#port: 9999 本地启的端口，随机选个不能被占用的，与dashboard进行数据交互，会在应用对应的机器上启动一个 Http Server，该 Server 会与 Sentinel 控制台做交互, 若被占用,则开始+1一次扫描</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>微服务注册上去后，由于Sentinel是懒加载模式，所以需要访问微服务后才会在控制台出现</p>
</li>
<li><p>限流配置实操</p>
<ul>
<li>控制台配置</li>
</ul>
</li>
</ul>
<p><img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/image-20200908203338254.png" alt="image-20200908203338254"></p>
<ul>
<li>浏览器刷新</li>
</ul>
<p><img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/image-20200908203307475.png" alt="image-20200908203307475"></p>
<h1 id="Sentinel多种流空规则和实战"><a href="#Sentinel多种流空规则和实战" class="headerlink" title="Sentinel多种流空规则和实战"></a>Sentinel多种流空规则和实战</h1><h2 id="Sentinel流量控制详细操作"><a href="#Sentinel流量控制详细操作" class="headerlink" title="Sentinel流量控制详细操作"></a><strong>Sentinel流量控制详细操作</strong></h2><ul>
<li><p>流量控制（flow control）</p>
<ul>
<li>原理是监控应用流量的 QPS 或并发线程数等指标，当达到指定的阈值时对流量进行控制，以避免被瞬时的流量高峰冲垮，从而保障应用的高可用性。</li>
</ul>
</li>
<li><p>两种规则</p>
<ul>
<li><p>基于统计并发线程数的流量控制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">并发数控制用于保护业务线程池不被慢调用耗尽</span><br><span class="line"></span><br><span class="line">Sentinel 并发控制不负责创建和管理线程池，而是简单统计当前请求上下文的线程数目（正在执行的调用数目）</span><br><span class="line"></span><br><span class="line">如果超出阈值，新的请求会被立即拒绝，效果类似于信号量隔离。</span><br></pre></td></tr></table></figure>
</li>
<li><p>基于统计QPS的流量控制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">当 QPS 超过某个阈值的时候，则采取措施进行流量控制</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>控制面板介绍</p>
<ul>
<li>资源名：默认是请求路径，可自定义</li>
<li>针对来源：对哪个微服务进行限流，默认是不区分来源，全部限流，这个是针对区分上游服务进行限流, 比如视频服务被订单服务、用户服务调用，就可以针对来源进行限流</li>
</ul>
</li>
</ul>
<p><img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/image-20200908210235984.png" alt="image-20200908210235984"></p>
<h2 id="基于并发线程数进行限流配置实操"><a href="#基于并发线程数进行限流配置实操" class="headerlink" title="基于并发线程数进行限流配置实操"></a>基于并发线程数进行限流配置实操</h2><ul>
<li><p>开发临时接口，方便测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"list"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">list</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        Map&lt;String,String&gt; map  = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"title1"</span>,<span class="string">"ALibabaCloud微服务专题"</span>);</span><br><span class="line">        map.put(<span class="string">"title2"</span>,<span class="string">"小滴课堂面试专题第一季"</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>基于统计并发线程数的流量控制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">并发数控制用于保护业务线程池不被慢调用耗尽</span><br><span class="line"></span><br><span class="line">Sentinel 并发控制不负责创建和管理线程池，而是简单统计当前请求上下文的线程数目（正在执行的调用数目）</span><br><span class="line"></span><br><span class="line">如果超出阈值，新的请求会被立即拒绝，效果类似于信号量隔离。并发数控制通常在调用端进行配置</span><br></pre></td></tr></table></figure>
</li>
<li><p>流控规则会下发到微服务，微服务如果重启，则流控规则会消失可以持久化配置</p>
</li>
<li><p>选择阈值类型 ”线程数“ ，配置是1</p>
</li>
<li><p>刷新浏览器</p>
</li>
</ul>
<h2 id="流控规则效果-直接拒绝-冷启动预热-匀速排队讲解"><a href="#流控规则效果-直接拒绝-冷启动预热-匀速排队讲解" class="headerlink" title="流控规则效果-直接拒绝-冷启动预热-匀速排队讲解"></a>流控规则效果-直接拒绝-冷启动预热-匀速排队讲解</h2><p><strong>基于并发线程进行限流配置实操</strong></p>
<p>流量控制的效果包括以下几种：</p>
<ul>
<li>直接拒绝：默认的流量控制方式，当QPS超过任意规则的阈值后，新的请求就会被立即拒绝</li>
<li>Warm Up：冷启动/预热，如果系统在此之前长期处于空闲的状态，我们希望处理请求的数量是缓步的增多，经过预期的时间以后，到达系统处理请求个数的最大值</li>
</ul>
<p><img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/image-20200908212417778.png" alt="image-20200908212417778"></p>
<p>匀速排队：严格控制请求通过的间隔时间，也即是让请求以均匀的速度通过，对应的是漏桶算法，主要用于处理间隔性突发的流量，如消息队列，想象一下这样的场景，在某一秒有大量的请求到来，而接下来的几秒则处于空闲状态，我们希望系统能够在接下来的空闲期间逐渐处理这些请求，而不是在第一秒直接拒绝多余的请求。</p>
<p><img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/68292442-d4af3c00-00c6-11ea-8251-d0977366d9b4.png" alt="image"></p>
<ul>
<li>注意：<ul>
<li>匀速排队等待策略是 Leaky Bucket 算法结合虚拟队列等待机制实现的。</li>
<li>匀速排队模式暂时不支持 QPS &gt; 1000 的场景</li>
</ul>
</li>
<li>流控文档<ul>
<li><a href="https://github.com/alibaba/Sentinel/wiki/流量控制#基于调用关系的限流" target="_blank" rel="noopener">https://github.com/alibaba/Sentinel/wiki/流量控制#基于调用关系的限流</a></li>
</ul>
</li>
</ul>
<h2 id="Sentinel-微服务高可用利器-熔断降级规则"><a href="#Sentinel-微服务高可用利器-熔断降级规则" class="headerlink" title="Sentinel-微服务高可用利器-熔断降级规则"></a>Sentinel-微服务高可用利器-熔断降级规则</h2><ul>
<li><p>备注：如果 簇点链路 没数据，刷多几次接口</p>
</li>
<li><p>熔断降级（虽然是两个概念，基本都是互相配合）</p>
<ul>
<li>对调用链路中不稳定的资源进行熔断降级也是保障高可用的重要措施之一</li>
<li>对不稳定的<strong>弱依赖服务调用</strong>进行熔断降级，暂时切断不稳定调用，避免局部不稳定因素导致整体的雪崩</li>
<li>熔断降级作为保护自身的手段，通常在客户端（调用端）进行配置</li>
</ul>
</li>
<li><p>什么是Sentinel降级规则</p>
<ul>
<li>文档：<a href="https://github.com/alibaba/Sentinel/wiki/熔断降级" target="_blank" rel="noopener">https://github.com/alibaba/Sentinel/wiki/熔断降级</a></li>
<li>就是配置一定规则，然后满足之后就对服务进行熔断降级</li>
</ul>
</li>
<li><p>Sentinel 熔断策略</p>
<ul>
<li><p>慢调用比例(响应时间): 选择以慢调用比例作为阈值，需要设置允许的慢调用 RT（即最大的响应时间），请求的响应时间大于该值则统计为慢调用</p>
<ul>
<li>比例阈值：修改后不生效-目前已经反馈给官方那边的bug</li>
<li>熔断时长：超过时间后会尝试恢复</li>
<li>最小请求数：熔断触发的最小请求数，请求数小于该值时即使异常比率超出阈值也不会熔断</li>
</ul>
<p><img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/image-20200909121342893.png" alt="image-20200909121342893"></p>
</li>
<li><p>异常比例：当单位统计时长内请求数目大于设置的最小请求数目，并且异常的比例大于阈值，则接下来的熔断时长内请求会自动被熔断</p>
<ul>
<li>比例阈值</li>
<li>熔断时长：超过时间后会尝试恢复</li>
<li>最小请求数：熔断触发的最小请求数，请求数小于该值时，即使异常比率超出阈值也不会熔断</li>
</ul>
<p><img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/image-20200909121357918.png" alt="image-20200909121357918"></p>
</li>
<li><p>异常数：当单位统计时长内的异常数目超过阈值之后会自动进行熔断</p>
<ul>
<li>异常数:</li>
<li>熔断时长：超过时间后会尝试恢复</li>
<li>最小请求数：熔断触发的最小请求数，请求数小于该值时即使异常比率超出阈值也不会熔断</li>
</ul>
<p><img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/image-20200909121415806.png" alt="image-20200909121415806"></p>
</li>
</ul>
</li>
</ul>
<h2 id="Sentinel的熔断状态和恢复"><a href="#Sentinel的熔断状态和恢复" class="headerlink" title="Sentinel的熔断状态和恢复"></a>Sentinel的熔断状态和恢复</h2><p>服务熔断一般有三种状态（画图）</p>
<ul>
<li>熔断关闭（Closed）<ul>
<li>服务没有故障时，熔断器所处的状态，对调用方的调用不做任何限制</li>
</ul>
</li>
<li>熔断开启（Open）<ul>
<li>后续对该服务接口的调用不再经过网络，直接执行本地的fallback方法</li>
</ul>
</li>
<li>半熔断（Half-Open）<ul>
<li>所谓半熔断就是尝试恢复服务调用，允许有限的流量调用该服务，并监控调用成功率</li>
</ul>
</li>
</ul>
<p><img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/image-20200909171947975.png" alt="image-20200909171947975"></p>
<ul>
<li><p>熔断恢复：</p>
<ul>
<li><p>经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态）尝试恢复服务调用，允许有限的流量调用该服务，并监控调用成功率。</p>
</li>
<li><p>如果成功率达到预期，则说明服务已恢复，进入熔断关闭状态；如果成功率仍旧很低，则重新进入熔断状态</p>
</li>
</ul>
</li>
</ul>
<h2 id="Sentinel整合AlibabaCloud微服务熔断实操"><a href="#Sentinel整合AlibabaCloud微服务熔断实操" class="headerlink" title="Sentinel整合AlibabaCloud微服务熔断实操"></a>Sentinel整合AlibabaCloud微服务熔断实操</h2><p>熔断测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> temp = <span class="number">0</span>;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"list"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">list</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//        try &#123;</span></span><br><span class="line"><span class="comment">//            TimeUnit.SECONDS.sleep(3);</span></span><br><span class="line"><span class="comment">//        &#125; catch (InterruptedException e) &#123;</span></span><br><span class="line"><span class="comment">//            e.printStackTrace();</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line">        temp++;</span><br><span class="line">        <span class="keyword">if</span>(temp%<span class="number">3</span> == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span>  <span class="keyword">new</span> RuntimeException();</span><br><span class="line">        &#125;</span><br><span class="line">        Map&lt;String,String&gt; map  = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"title1"</span>,<span class="string">"ALibabaCloud微服务专题"</span>);</span><br><span class="line">        map.put(<span class="string">"title2"</span>,<span class="string">"小滴课堂面试专题第一季"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h1 id="Sentinel自定义异常-整合Open-Feign"><a href="#Sentinel自定义异常-整合Open-Feign" class="headerlink" title="Sentinel自定义异常-整合Open-Feign"></a>Sentinel自定义异常-整合Open-Feign</h1><h2 id="AlibabaCloud版本升级-自定义降级异常-sentinel不向下兼容的坑"><a href="#AlibabaCloud版本升级-自定义降级异常-sentinel不向下兼容的坑" class="headerlink" title="AlibabaCloud版本升级-自定义降级异常-sentinel不向下兼容的坑"></a>AlibabaCloud版本升级-自定义降级异常-sentinel不向下兼容的坑</h2><ul>
<li><p>默认降级返回数据问题</p>
<ul>
<li><p>限流和熔断返回的数据有问题</p>
<p>Blocked by Sentinel (flow limiting)</p>
</li>
<li><p>微服务交互基本都是json格式，需要自定义异常信息</p>
</li>
</ul>
</li>
<li><p>AlibabCloud版本升级，不兼容问题</p>
<ul>
<li>v2.1.0到v2.2.0后，Sentinel里面依赖进行了改动，且不向下兼容</li>
</ul>
</li>
<li><p>自定义降级返回数据</p>
<ul>
<li><p>【旧版】实现UrlBlockHandler并且重写blocked方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XdclassUrlBlockHandler</span> <span class="keyword">implements</span> <span class="title">UrlBlockHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">blocked</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, BlockException e)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">       <span class="comment">//降级业务处理</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>【新版】实现BlockExceptionHandler并且重写handle方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XdclassUrlBlockHandler</span> <span class="keyword">implements</span> <span class="title">BlockExceptionHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, BlockException e)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">//降级业务处理</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h2 id="Sentinel自定义降级异常数据开发实战"><a href="#Sentinel自定义降级异常数据开发实战" class="headerlink" title="Sentinel自定义降级异常数据开发实战"></a>Sentinel自定义降级异常数据开发实战</h2><p>异常种类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FlowException  &#x2F;&#x2F;限流异常</span><br><span class="line">DegradeException  &#x2F;&#x2F;降级异常</span><br><span class="line">ParamFlowException &#x2F;&#x2F;参数限流异常</span><br><span class="line">SystemBlockException &#x2F;&#x2F;系统负载异常</span><br><span class="line">AuthorityException &#x2F;&#x2F;授权异常</span><br></pre></td></tr></table></figure>

<ul>
<li><p>【新版】实现BlockExceptionHandler并且重写handle方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XdclassUrlBlockHandler</span> <span class="keyword">implements</span> <span class="title">BlockExceptionHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, BlockException e)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Map&lt;String,Object&gt; backMap=<span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> FlowException)&#123;</span><br><span class="line">            backMap.put(<span class="string">"code"</span>,-<span class="number">1</span>);</span><br><span class="line">            backMap.put(<span class="string">"msg"</span>,<span class="string">"限流-异常啦"</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> DegradeException)&#123;</span><br><span class="line">            backMap.put(<span class="string">"code"</span>,-<span class="number">2</span>);</span><br><span class="line">            backMap.put(<span class="string">"msg"</span>,<span class="string">"降级-异常啦"</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ParamFlowException)&#123;</span><br><span class="line">            backMap.put(<span class="string">"code"</span>,-<span class="number">3</span>);</span><br><span class="line">            backMap.put(<span class="string">"msg"</span>,<span class="string">"热点-异常啦"</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> SystemBlockException)&#123;</span><br><span class="line">            backMap.put(<span class="string">"code"</span>,-<span class="number">4</span>);</span><br><span class="line">            backMap.put(<span class="string">"msg"</span>,<span class="string">"系统规则-异常啦"</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> AuthorityException)&#123;</span><br><span class="line">            backMap.put(<span class="string">"code"</span>,-<span class="number">5</span>);</span><br><span class="line">            backMap.put(<span class="string">"msg"</span>,<span class="string">"认证-异常啦"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置返回json数据</span></span><br><span class="line">        httpServletResponse.setStatus(<span class="number">200</span>);</span><br><span class="line">        httpServletResponse.setHeader(<span class="string">"content-Type"</span>,<span class="string">"application/json;charset=UTF-8"</span>);</span><br><span class="line">        httpServletResponse.getWriter().write(JSON.toJSONString(backMap));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="Sentinel整合OpenFeign配置实战"><a href="#Sentinel整合OpenFeign配置实战" class="headerlink" title="Sentinel整合OpenFeign配置实战"></a>Sentinel整合OpenFeign配置实战</h2><p>整合步骤</p>
<ul>
<li><p>每个微服务都加入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>开启Feign对Sentinel的支持</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">sentinel:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建容错类, 实现对应的服务接口, 记得加注解 @Service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoServiceFallback</span> <span class="keyword">implements</span> <span class="title">VideoService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Video <span class="title">findById</span><span class="params">(<span class="keyword">int</span> videoId)</span> </span>&#123;</span><br><span class="line">        Video video = <span class="keyword">new</span> Video();</span><br><span class="line">        video.setTitle(<span class="string">"熔断降级数据"</span>);</span><br><span class="line">        <span class="keyword">return</span> video;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Video <span class="title">saveVideo</span><span class="params">(Video video)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置feign容错类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//添加fallback = VideoServiceFallback.class</span></span><br><span class="line"><span class="meta">@FeignClient</span>(value = <span class="string">"xdclass-video-service"</span>, fallback = VideoServiceFallback<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">interface</span> <span class="title">VideoService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/api/v1/video/save"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">save</span><span class="params">(@RequestBody Video video)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/api/v1/video/find_by_id"</span>)</span><br><span class="line">    <span class="function">Video <span class="title">findById</span><span class="params">(@RequestParam(<span class="string">"videoId"</span>)</span> <span class="keyword">int</span> videoId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>准备 <strong>兜底数据</strong></p>
</li>
</ul>
<h1 id="AlibabaCloud微服务升级下一代-JDK11-LTS长期支持版本"><a href="#AlibabaCloud微服务升级下一代-JDK11-LTS长期支持版本" class="headerlink" title="AlibabaCloud微服务升级下一代 JDK11 LTS长期支持版本"></a>AlibabaCloud微服务升级下一代 JDK11 LTS长期支持版本</h1><h2 id="JDK各个版本常⻅问题"><a href="#JDK各个版本常⻅问题" class="headerlink" title="JDK各个版本常⻅问题"></a>JDK各个版本常⻅问题</h2><ul>
<li>OpenJDK和OracleJDK版本区别<ul>
<li>OpenJDK是JDK的开放源码版本，以GPL协议的形式发布（General Public License）</li>
<li>Oracle JDK采⽤了商业实现</li>
</ul>
</li>
<li>LTS 是啥意思？<ul>
<li>Long Term Support ⻓期⽀持的版本，如JDK8、JDK11都是属于LTS</li>
<li>JDK9 和 JDK10 这两个被称为“功能性的版本”不同, 两者均只提供半年的技术⽀持</li>
<li>甲⻣⽂释出Java的政策，每6个⽉会有⼀个版本的释出，⻓期⽀持版本每三年发布⼀次，根据 后续的发布计划，下⼀个⻓期⽀持版 Java 17 将于2021年发布</li>
</ul>
</li>
<li>8u20、11u20是啥意思？<ul>
<li>就是Java的补丁，⽐如JDK8的 8u20版本、8u60版本; java11的 11u20、11u40版本</li>
</ul>
</li>
</ul>
<h2 id="AlibabaCloud微服务升级JDK11和配置"><a href="#AlibabaCloud微服务升级JDK11和配置" class="headerlink" title="AlibabaCloud微服务升级JDK11和配置"></a>AlibabaCloud微服务升级JDK11和配置</h2><ul>
<li>安装包（课程资料里面，和正常jdk安装没区别）</li>
<li>IDEA配置<ul>
<li>procject structure</li>
<li>偏好设置-编译版本</li>
</ul>
</li>
<li>maven项目配置</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>11<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>11<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>11<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>版本选择：</p>
<ul>
<li>只要不是JDK8以下就行，</li>
<li>也不建议用最新的，比如现在JDK14或者JDK17是吧</li>
<li>涉及到中间件的升级，不排除有些版本是把老版本的代码删除了，就GG了</li>
</ul>
</li>
<li><p>版本选择：</p>
<ul>
<li>只要不是JDK8以下就行，</li>
<li>也不建议用最新的，比如现在JDK14或者JDK17是吧</li>
<li>涉及到中间件的升级，不排除有些版本是把老版本的代码删除了，就GG了</li>
</ul>
</li>
</ul>
<h1 id="微服务核心组件之网关"><a href="#微服务核心组件之网关" class="headerlink" title="微服务核心组件之网关"></a>微服务核心组件之网关</h1><h2 id="微服务的网关和应用场景"><a href="#微服务的网关和应用场景" class="headerlink" title="微服务的网关和应用场景"></a>微服务的网关和应用场景</h2><p>什么是网关</p>
<ul>
<li><p>API Gateway，是系统的唯一对外的入口，介于客户端和服务器端之间的中间层，处理非业务功能 提供路由请求、鉴权、监控、缓存、限流等功能</p>
</li>
<li><p>统一接入</p>
<ul>
<li>智能路由</li>
<li>AB测试、灰度测试</li>
<li>负载均衡、容灾处理</li>
<li>日志埋点（类似Nignx日志）</li>
</ul>
</li>
<li><p>流量监控</p>
<ul>
<li>限流处理</li>
<li>服务降级</li>
</ul>
</li>
<li><p>安全防护</p>
<ul>
<li>鉴权处理</li>
<li>监控</li>
<li>机器网络隔离</li>
</ul>
</li>
<li><p>主流的网关</p>
<ul>
<li>zuul：是Netflix开源的微服务网关，和Eureka,Ribbon,Hystrix等组件配合使用，依赖组件比较多，性能教差</li>
<li>kong: 由Mashape公司开源的，基于Nginx的API gateway</li>
</ul>
</li>
<li><p>nginx+lua：是一个高性能的HTTP和反向代理服务器,lua是脚本语言，让Nginx执行Lua脚本，并且高并发、非阻塞的处理各种请求</p>
</li>
<li><p>springcloud gateway: Spring公司专门开发的网关，替代zuul</p>
</li>
<li><p>注意：AlibabaCloud全家桶还没对应的网关，我们就用SpringCloud官方推荐的Gateway</p>
</li>
</ul>
<p><img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/image-20200910120344509.png" alt="image-20200910120344509"></p>
<h2 id="微服务的网关SpringCloud-Gateway介绍"><a href="#微服务的网关SpringCloud-Gateway介绍" class="headerlink" title="微服务的网关SpringCloud Gateway介绍"></a>微服务的网关SpringCloud Gateway介绍</h2><ul>
<li><p>什么是 SpringCloud Gateway</p>
<ul>
<li>Spring官方出品，基于Spring5+Reactor技术开发的网关</li>
<li>性能强劲基于Reactor+WebFlux、功能多样</li>
<li>基于springboot2.x, 直接可以jar包方式运行</li>
</ul>
</li>
<li><p>官方文档</p>
<ul>
<li><a href="https://spring.io/projects/spring-cloud-gateway" target="_blank" rel="noopener">https://spring.io/projects/spring-cloud-gateway</a></li>
</ul>
</li>
</ul>
<h2 id="SpringCloud-Gateway项目创建和依赖添加"><a href="#SpringCloud-Gateway项目创建和依赖添加" class="headerlink" title="SpringCloud Gateway项目创建和依赖添加"></a>SpringCloud Gateway项目创建和依赖添加</h2><p>创建Gateway项目</p>
<ul>
<li>添加依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>配置实战</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8888</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">api-gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span> <span class="comment">#数组形式</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">order-service</span>  <span class="comment">#路由唯一标识</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://127.0.0.1:8000</span>  <span class="comment">#想要转发到的地址</span></span><br><span class="line">          <span class="attr">order:</span> <span class="number">1</span> <span class="comment">#优先级，数字越小优先级越高</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment">#断言 配置哪个路径才转发</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/order-server/**</span></span><br><span class="line">          <span class="attr">filters:</span> <span class="comment">#过滤器，请求在传递过程中通过过滤器修改</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">StripPrefix=1</span>  <span class="comment">#去掉第一层前缀</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#访问路径 http://localhost:8888/order-server/api/v1/video_order/list</span></span><br><span class="line"><span class="comment">#转发路径 http://localhost:8000/order-server/api/v1/video_order/list  </span></span><br><span class="line"><span class="comment">#需要过滤器去掉前面第一层</span></span><br></pre></td></tr></table></figure>

<ul>
<li>配置项怎么看？<ul>
<li>点击routes进去</li>
</ul>
</li>
</ul>
<h2 id="SpringCloud-Gateway网关整合Nacos开发实战"><a href="#SpringCloud-Gateway网关整合Nacos开发实战" class="headerlink" title="SpringCloud Gateway网关整合Nacos开发实战"></a>SpringCloud Gateway网关整合Nacos开发实战</h2><ul>
<li><p>原先存在的问题</p>
<ul>
<li>微服务地址写死</li>
<li>负载均衡没做到</li>
</ul>
</li>
<li><p>添加Nacos服务治理配置</p>
<ul>
<li><p>网关添加naocs依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--添加nacos客户端--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动类开启支持</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改配置文件</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8888</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">api-gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span> <span class="comment">#数组形式</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">order-service</span>  <span class="comment">#路由唯一标识</span></span><br><span class="line">          <span class="comment"># uri: http://127.0.0.1:8000  #想要转发到的地址</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://xdclass-order-service</span>  <span class="comment"># 从nacos获取名称转发,lb是负载均衡轮训策略</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment">#断言 配置哪个路径才转发</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/order-server/**</span></span><br><span class="line">          <span class="attr">filters:</span> <span class="comment">#过滤器，请求在传递过程中通过过滤器修改</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">StripPrefix=1</span> <span class="comment">#去掉第一层前缀</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span>  <span class="comment">#开启网关拉取nacos的服务</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 访问路径 http://localhost:8888/order-server/api/v1/video_order/list</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
</li>
</ul>
<h1 id="网关Gateway架构-断言-过滤器进阶实战"><a href="#网关Gateway架构-断言-过滤器进阶实战" class="headerlink" title="网关Gateway架构+断言+过滤器进阶实战"></a>网关Gateway架构+断言+过滤器进阶实战</h1><h2 id="SpringCloud-Gateway架构流程"><a href="#SpringCloud-Gateway架构流程" class="headerlink" title="SpringCloud Gateway架构流程"></a>SpringCloud Gateway架构流程</h2><p>网关的配置项回顾</p>
<ul>
<li><p>路由：是网关的基本单元，由ID、URI、一组Predicate、一组Filter组成，根据Predicate进行匹配转发</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">route组成部分:</span><br><span class="line">id：路由的ID</span><br><span class="line">uri：匹配路由的转发地址</span><br><span class="line">predicates：配置该路由的断言，通过PredicateDefinition类进行接收配置。</span><br><span class="line">order：路由的优先级，数字越小，优先级越高。</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>交互流程</p>
<ul>
<li><p>客户端向Spring Cloud Gateway发出请求</p>
</li>
<li><p>如果网关处理程序映射确定请求与路由匹配</p>
</li>
<li><p>则将其发送到网关Web处理程序</p>
</li>
<li><p>通过特定过滤器链运行，前置处理-后置处理</p>
<p><img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/spring_cloud_gateway_diagram.png" alt="Spring Cloud网关图"></p>
</li>
</ul>
<h2 id="微服务SpringCloud-Gateway内置路由断言"><a href="#微服务SpringCloud-Gateway内置路由断言" class="headerlink" title="微服务SpringCloud Gateway内置路由断言"></a>微服务SpringCloud Gateway内置路由断言</h2><ul>
<li><p>什么是Gateway路由断言</p>
<ul>
<li>Predicate 来源于Java8，接受输入参数，返回一个布尔值结果</li>
<li>Spring Cloud Gateway 中 Spring 利用 Predicate 的特性实现了各种路由匹配规则</li>
<li>转发的判断条件，SpringCloud Gateway支持多种方式，常见如：Path、Query、Method、Header等</li>
<li>支持多个<code>Predicate</code>请求的转发是必须满足所有的<code>Predicate</code>后才可以进行路由转发</li>
</ul>
</li>
<li><p>内置路由断言介绍 RoutePredicateFactory 接口实现类</p>
<p><img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/image-20200910144246781.png" alt="image-20200910144246781"></p>
</li>
<li><p>参数编写规则 XXXRoutePredicateFactory，使用XXX作为参数配置, 例如下面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">predicates:</span><br><span class="line">  - Host&#x3D;</span><br><span class="line">  - Path&#x3D;</span><br><span class="line">  - Method&#x3D;</span><br><span class="line">  - Header&#x3D;</span><br><span class="line">  - Query&#x3D;</span><br><span class="line">  - Cookie&#x3D;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="Gateway内置断言实现接口定时下线实战"><a href="#Gateway内置断言实现接口定时下线实战" class="headerlink" title="Gateway内置断言实现接口定时下线实战"></a>Gateway内置断言实现接口定时下线实战</h2><ul>
<li>需求：接口需要在指定时间进行下线，过后不可以再被访问<ul>
<li>使用Before，只要当前时间小于设定时间，路由才会匹配请求</li>
<li>东8区的2020-09-11T01:01:01.000+08:00后，请求不可访问</li>
<li>为了方便测试，修改时间即可</li>
</ul>
</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">predicates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Before=2020-09-09T01:01:01.000+08:00</span></span><br></pre></td></tr></table></figure>

<h2 id="SpringCloud-Gateway过滤器"><a href="#SpringCloud-Gateway过滤器" class="headerlink" title="SpringCloud Gateway过滤器"></a>SpringCloud Gateway过滤器</h2><ul>
<li><p>什么是网关的过滤器</p>
<p><img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/spring_cloud_gateway_diagram.png" alt="Spring Cloud网关图"></p>
</li>
<li><p>过滤器生命周期</p>
<ul>
<li>PRE： 这种过滤器在请求被路由之前调用，一般用于鉴权、限流等</li>
<li>POST：这种过滤器在路由到微服务以后执行，一般用于修改响应结果，比如增加header信息、打点结果日志</li>
</ul>
</li>
<li><p>网关过滤器分类</p>
<ul>
<li>局部过滤器GatewayFilter：应用在某个路由上,每个过滤器工厂都对应一个实现类，并且这些类的名称必须以 GatewayFilterFactory 结尾</li>
</ul>
</li>
<li><p>内置很多局部过滤器，顶级接口 GatewayFilterFactory</p>
<p><img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/image-20200910151857760.png" alt="image-20200910151857760"></p>
</li>
<li><p>内置很多全局过滤器，顶级接口 GlobalFilter</p>
<p><img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/image-20200910152346987.png" alt="image-20200910152346987"></p>
</li>
</ul>
<h2 id="网关Gateway全局过滤器实现用户鉴权"><a href="#网关Gateway全局过滤器实现用户鉴权" class="headerlink" title="网关Gateway全局过滤器实现用户鉴权"></a>网关Gateway全局过滤器实现用户鉴权</h2><ul>
<li><p>自定义全局过滤器实现鉴权</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserGlobalFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>,<span class="title">Ordered</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</span><br><span class="line">        String token = exchange.getRequest().getHeaders().getFirst(<span class="string">"token"</span>);</span><br><span class="line">        System.out.println(token);</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isBlank(token))&#123;</span><br><span class="line">            exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">            <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//继续往下执行</span></span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//数字越小，优先级越高</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>路径 ：<a href="http://localhost:8888/order-server/api/v1/video_order/list" target="_blank" rel="noopener">http://localhost:8888/order-server/api/v1/video_order/list</a></p>
</li>
<li><p>注意：网关不要加太多业务逻辑，否则会影响性能，务必记住</p>
</li>
</ul>
<h1 id="AlibabaCloud微服务下的链路追踪系统实战"><a href="#AlibabaCloud微服务下的链路追踪系统实战" class="headerlink" title="AlibabaCloud微服务下的链路追踪系统实战"></a>AlibabaCloud微服务下的链路追踪系统实战</h1><h2 id="微服务架构下的排查问题复杂性概述"><a href="#微服务架构下的排查问题复杂性概述" class="headerlink" title="微服务架构下的排查问题复杂性概述"></a>微服务架构下的排查问题复杂性概述</h2><ul>
<li><p>抛两个常见的问题</p>
<ul>
<li>微服务调用链路出现了问题怎么快速排查？</li>
</ul>
</li>
<li><p>微服务调用链路耗时长怎么定位是哪个服务？</p>
</li>
<li><p>链路追踪系统</p>
<ul>
<li>分布式应用架构虽然满足了应用横向扩展的需求，但是运维和诊断的过程变得越来越复杂，例如会遇到接口诊断困难、应用性能诊断复杂、架构分析复杂等难题，传统的监控工具并无法满足，分布式链路系统由此诞生</li>
</ul>
</li>
<li><p>核心：将一次请求分布式调用，使用GPS定位串起来，记录每个调用的耗时、性能等日志，并通过可视化工具展示出来</p>
</li>
<li><p>注意：AlibabaCloud全家桶还没对应的链路追踪系统，我们使用Sleuth和zipking（内部使用的鹰眼）</p>
</li>
</ul>
<h2 id="SpringCloud的链路追踪组件Sleuth实战"><a href="#SpringCloud的链路追踪组件Sleuth实战" class="headerlink" title="SpringCloud的链路追踪组件Sleuth实战"></a>SpringCloud的链路追踪组件Sleuth实战</h2><ul>
<li><p>什么是Sleuth</p>
<ul>
<li>一个组件，专门用于记录链路数据的开源组件</li>
<li>文档：<a href="https://spring.io/projects/spring-cloud-sleuth" target="_blank" rel="noopener">https://spring.io/projects/spring-cloud-sleuth</a></li>
<li>案例</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[order-service,96f95a0dd81fe3ab,852ef4cfcdecabf3,false]</span><br><span class="line">    </span><br><span class="line">    第一个值，spring.application.name的值</span><br><span class="line">    </span><br><span class="line">    第二个值，96f95a0dd81fe3ab ，sleuth生成的一个ID，叫Trace ID，用来标识一条请求链路，一条请求链路中包含一个Trace ID，多个Span ID</span><br><span class="line">    </span><br><span class="line">    第三个值，852ef4cfcdecabf3、spanid 基本的工作单元，获取元数据，如发送一个http</span><br><span class="line">    </span><br><span class="line">    第四个值：false，是否要将该信息输出到zipkin服务中来收集和展示。</span><br></pre></td></tr></table></figure>
</li>
<li><p>各个微服务添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-sleuth<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="微服务下的可视化链路追踪系统Zipkin实战"><a href="#微服务下的可视化链路追踪系统Zipkin实战" class="headerlink" title="微服务下的可视化链路追踪系统Zipkin实战"></a>微服务下的可视化链路追踪系统Zipkin实战</h2><ul>
<li><p>什么是zipkin</p>
<ul>
<li>官网<ul>
<li><a href="https://zipkin.io/" target="_blank" rel="noopener">https://zipkin.io/</a></li>
<li><a href="https://zipkin.io/pages/quickstart.html" target="_blank" rel="noopener">https://zipkin.io/pages/quickstart.html</a></li>
</ul>
</li>
<li>大规模分布式系统的APM工具（Application Performance Management）,基于Google Dapper的基础实现，和sleuth结合可以提供可视化web界面分析调用链路耗时情况</li>
</ul>
</li>
<li><p>同类产品</p>
<ul>
<li>鹰眼（EagleEye）</li>
<li>CAT</li>
<li>twitter开源zipkin，结合sleuth</li>
<li>Pinpoint，运用JavaAgent字节码增强技术</li>
</ul>
</li>
<li><p>StackDriver Trace (Google)</p>
</li>
<li><p>开始使用</p>
<ul>
<li><p>安装包在资料里面，启动服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar zipkin-server-2.12.9-exec.jar</span><br></pre></td></tr></table></figure>
</li>
<li><p>访问入口：<a href="http://127.0.0.1:9411/zipkin/" target="_blank" rel="noopener">http://127.0.0.1:9411/zipkin/</a></p>
</li>
<li><p>zipkin组成：Collector、Storage、Restful API、Web UI组成</p>
<p><img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/architecture-1.png" alt="architecture-1"></p>
</li>
</ul>
</li>
</ul>
<h2 id="链路追踪组件Zipkin-Sleuth整合实战"><a href="#链路追踪组件Zipkin-Sleuth整合实战" class="headerlink" title="链路追踪组件Zipkin+Sleuth整合实战"></a>链路追踪组件Zipkin+Sleuth整合实战</h2><ul>
<li><p>sleuth收集跟踪信息通过http请求发送给zipkin server</p>
</li>
<li><p>zipkin server进行跟踪信息的存储以及提供Rest API即可</p>
</li>
<li><p>Zipkin UI调用其API接口进行数据展示默认存储是内存，可也用mysql 或者elasticsearch等存储</p>
</li>
<li><p>微服务加入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zipkin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置地址和采样百分比配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">api-gateway</span></span><br><span class="line">  <span class="attr">zipkin:</span></span><br><span class="line">    <span class="attr">base-url:</span> <span class="string">http://127.0.0.1:9411/</span> <span class="comment">#zipkin地址</span></span><br><span class="line">    <span class="attr">discovery-client-enabled:</span> <span class="literal">false</span>  <span class="comment">#不用开启服务发现</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">sleuth:</span></span><br><span class="line">    <span class="attr">sampler:</span></span><br><span class="line">      <span class="attr">probability:</span> <span class="number">1.0</span> <span class="comment">#采样百分比</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">默认为0.1，即10%，这里配置1，是记录全部的sleuth信息，是为了收集到更多的数据（仅供测试用）。</span><br><span class="line">在分布式系统中，过于频繁的采样会影响系统性能，所以这里配置需要采用一个合适的值。</span><br></pre></td></tr></table></figure>

<p><img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/image-20200910233308640.png" alt="image-20200910233308640"></p>
<p><img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/image-20200910233241449.png" alt="image-20200910233241449"></p>
</li>
</ul>
<h2 id="微服务链路追踪系统Zipkin持久化配置"><a href="#微服务链路追踪系统Zipkin持久化配置" class="headerlink" title="微服务链路追踪系统Zipkin持久化配置"></a>微服务链路追踪系统Zipkin持久化配置</h2><ul>
<li><p>现存在的问题</p>
<ul>
<li>zipkin重启会导致链路追踪系统数据丢失</li>
</ul>
</li>
<li><p>持久化配置：mysql或者elasticsearch</p>
<ul>
<li><p>创建数据库表SQL脚本 (本章本集的资料里面, 不要说找不到)</p>
</li>
<li><p>启动命令</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java <span class="literal">-jar</span> zipkin<span class="literal">-server</span><span class="literal">-2</span>.<span class="number">12.9</span><span class="literal">-exec</span>.jar -<span class="literal">-STORAGE_TYPE</span>=mysql -<span class="literal">-MYSQL_HOST</span>=<span class="number">127.0</span>.<span class="number">0.1</span> -<span class="literal">-MYSQL_TCP_PORT</span>=<span class="number">3306</span> -<span class="literal">-MYSQL_DB</span>=zipkin_log -<span class="literal">-MYSQL_USER</span>=root -<span class="literal">-MYSQL_PASS</span>=root</span><br></pre></td></tr></table></figure>

<p>注意MySQL8版本会有所不同，可以看<strong>Alibaba Cloud实战之报错篇</strong></p>
</li>
</ul>
</li>
</ul>
<h1 id="AlibabaCloud微服务下的分布式配置中心实战"><a href="#AlibabaCloud微服务下的分布式配置中心实战" class="headerlink" title="AlibabaCloud微服务下的分布式配置中心实战"></a>AlibabaCloud微服务下的分布式配置中心实战</h1><h2 id="微服务下的分布式配置中心"><a href="#微服务下的分布式配置中心" class="headerlink" title="微服务下的分布式配置中心"></a>微服务下的分布式配置中心</h2><ul>
<li>现在微服务存在的问题<ul>
<li>配置文件增多，不好维护</li>
<li>修改配置文件需要重新发布</li>
</ul>
</li>
<li>什么是配置中心：<ul>
<li>一句话：统一管理配置, 快速切换各个环境的配置</li>
<li>相关产品：<ul>
<li>百度的disconf 地址:<a href="https://github.com/knightliao/disconf" target="_blank" rel="noopener">https://github.com/knightliao/disconf</a></li>
<li>阿里的diamand 地址：<a href="https://github.com/takeseem/diamond" target="_blank" rel="noopener">https://github.com/takeseem/diamond</a></li>
<li>springcloud的configs-server: 地址：<a href="http://cloud.spring.io/spring-cloud-config/" target="_blank" rel="noopener">http://cloud.spring.io/spring-cloud-config/</a></li>
<li>阿里的Nacos:既可以当服务治理，又可以当配置中心，Nacos = Eureka + Config</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="AlibabaCloud配置中心Nacos面板介绍"><a href="#AlibabaCloud配置中心Nacos面板介绍" class="headerlink" title="AlibabaCloud配置中心Nacos面板介绍"></a>AlibabaCloud配置中心Nacos面板介绍</h2><p><img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/image-20200911103548567.png" alt="image-20200911103548567"></p>
<ul>
<li><p>项目添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>官方文档</p>
<ul>
<li><a href="https://github.com/alibaba/spring-cloud-alibaba/wiki/Nacos-config" target="_blank" rel="noopener">https://github.com/alibaba/spring-cloud-alibaba/wiki/Nacos-config</a></li>
</ul>
</li>
<li><p>配置文件优先级讲解</p>
<ul>
<li>不能使用原先的application.yml, 需要使用bootstrap.yml作为配置文件</li>
<li>配置读取优先级 bootstrap.yml &gt; application.yml</li>
</ul>
</li>
<li><p>配置实操</p>
<ul>
<li><p>订单服务迁移配置</p>
</li>
<li><p>增加bootstrap.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">xdclass-order-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span> <span class="comment">#Nacos配置中心地址</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span> <span class="comment">#文件拓展格式</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>启动微服务服务验证</p>
<ul>
<li>测试是否可以获取配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">浏览器访问 </span><br><span class="line">http:&#x2F;&#x2F;127.0.0.1:8848&#x2F;nacos&#x2F;v1&#x2F;cs&#x2F;configs?dataId&#x3D;xdclass-order-service-dev.yaml&amp;group&#x3D;DEFAULT_GROUP</span><br><span class="line"></span><br><span class="line">部分同学如果出现 config dta not exist 建议重启nacos</span><br></pre></td></tr></table></figure>

<ul>
<li>除上述问题，如果还是拉取不到配置(保持和课程版本，文件名一样先)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">重新构建下项目 </span><br><span class="line"></span><br><span class="line">mvn clean package -U</span><br><span class="line"></span><br><span class="line">然后重启IDEA</span><br></pre></td></tr></table></figure>

<ul>
<li>dataId组成，在 Nacos Spring Cloud 中，dataId 的完整格式如下</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$&#123;prefix&#125;-$&#123;spring.profiles.active&#125;.$&#123;file-extension&#125;</span><br><span class="line"></span><br><span class="line">prefix 默认为 spring.application.name 的值</span><br><span class="line"></span><br><span class="line">spring.profiles.active 即为当前环境对应的 profile</span><br><span class="line">当 spring.profiles.active 为空时，对应的连接符 - 也将不存在，dataId 的拼接格式变成 $&#123;prefix&#125;.$&#123;file-extension&#125;</span><br><span class="line"></span><br><span class="line">file-exetension 为配置内容的数据格式，可以通过配置项 spring.cloud.nacos.config.file-extension 来配置。目前只支持 properties 和 yaml 类型。</span><br></pre></td></tr></table></figure>

<p><img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/image-20200911132840504.png" alt="image-20200911132840504"></p>
</li>
</ul>
<h2 id="AlibabaCloud配置中心Nacos动态配置下发实战"><a href="#AlibabaCloud配置中心Nacos动态配置下发实战" class="headerlink" title="AlibabaCloud配置中心Nacos动态配置下发实战"></a>AlibabaCloud配置中心Nacos动态配置下发实战</h2><ul>
<li>什么是动态刷新配置<ul>
<li>我们修改了配置，程序不能自动更新</li>
<li>动态刷新就可以解决这个问题</li>
</ul>
</li>
<li>配置实战<ul>
<li>增加Nacos增加测试配置</li>
<li>编写代码</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;video.title&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String videoTitle;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="微服务容器化部署Docker"><a href="#微服务容器化部署Docker" class="headerlink" title="微服务容器化部署Docker"></a>微服务容器化部署Docker</h1><ul>
<li><p>官网：<a href="https://www.docker.com/get-started" target="_blank" rel="noopener">https://www.docker.com/get-started</a></p>
</li>
<li><p>什么是Dokcer</p>
<ul>
<li>百科:一个开源的应用容器引擎，让开发者可以打包他们的应用以及依赖包到一个可移植的容器中，然后发布到任何流行的 Linux 机器上，也可以实现虚拟化。</li>
<li>容器是完全使用沙箱机制，相互之间不会有任何接口，使用go语言编写，在<a href="https://linuxcontainers.org/" target="_blank" rel="noopener">Linux Containers</a>基础上进行的封装</li>
</ul>
</li>
<li><p>简单来说：</p>
<ul>
<li>就是可以快速部署启动应用</li>
<li>实现虚拟化，完整资源隔离</li>
<li>一次编写，四处运行</li>
<li>但有一定的限制，比如Docker是基于Linux 64bit的，无法在32bit的linux/Windows/unix环境下使用</li>
</ul>
</li>
<li><p>为什么要用</p>
<ul>
<li>提供一次性的环境，假如需要安装Mysql，则需要安装很多依赖库、版本等，如果使用Docker则通过镜像就可以直接启动运行</li>
<li>快速动态扩容，使用docker部署了一个应用，可以制作成镜像，然后通过Dokcer快速启动</li>
<li>组建微服务架构，可以在一个机器上模拟出多个微服务，启动多个应用</li>
<li>更好的资源隔离和共享</li>
<li>一句话：开箱即用，快速部署，可移植性强，环境隔离</li>
</ul>
</li>
</ul>
<h2 id="阿里云Linux云服务器Centos-64位安装Docker实战"><a href="#阿里云Linux云服务器Centos-64位安装Docker实战" class="headerlink" title="阿里云Linux云服务器Centos 64位安装Docker实战"></a>阿里云Linux云服务器Centos 64位安装Docker实战</h2><ul>
<li><p>远程连接ECS实例</p>
</li>
<li><p>依次运行以下命令添加yum源。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum update</span><br><span class="line">yum install epel-release -y</span><br><span class="line">yum clean all</span><br><span class="line">yum list</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装并运行Docker</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install docker-io -y</span><br><span class="line">systemctl start docker</span><br></pre></td></tr></table></figure>
</li>
<li><p>检查安装结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker info</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动使用Docker</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start docker     #运行Docker守护进程</span><br><span class="line">systemctl stop docker      #停止Docker守护进程</span><br><span class="line">systemctl restart docker   #重启Docker守护进程</span><br></pre></td></tr></table></figure>
</li>
<li><p>更多文档</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;help.aliyun.com&#x2F;document_detail&#x2F;51853.html?spm&#x3D;a2c4g.11186623.6.820.RaToNY</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="快速掌握-Docker仓库、镜像、容器核心概念"><a href="#快速掌握-Docker仓库、镜像、容器核心概念" class="headerlink" title="快速掌握 Docker仓库、镜像、容器核心概念"></a>快速掌握 Docker仓库、镜像、容器核心概念</h2><ul>
<li><p>Docker 镜像 - Docker images：容器运行的只读模板，操作系统+软件运行环境+用户程序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</span><br><span class="line">     <span class="keyword">private</span> String userName;</span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Docker 容器 - Docker containers：容器包含了某个应用运行所需要的全部环境</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User user = <span class="keyword">new</span> User()</span><br></pre></td></tr></table></figure>
</li>
<li><p>Docker 仓库 - Docker registories： 用来保存镜像，有公有和私有仓库，好比Maven的中央仓库和本地私服</p>
</li>
<li><p>总结：对比面向对象的方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Dokcer 里面的镜像 : Java里面的类 Class</span><br><span class="line">Docker 里面的容器 : Java里面的对象 Object</span><br><span class="line">通过类创建对象，通过镜像创建容器</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="Docker容器常见命令实战"><a href="#Docker容器常见命令实战" class="headerlink" title="Docker容器常见命令实战"></a>Docker容器常见命令实战</h2><ul>
<li><p>常用命令（安装部署好Docker后，执行的命令是docker开头），xxx是镜像名称</p>
</li>
<li><p>搜索镜像：docker search xxx</p>
</li>
<li><p>列出当前系统存在的镜像：docker images</p>
</li>
<li><p>拉取镜像：docker pull xxx</p>
<ul>
<li>xxx是具体某个镜像名称(格式 REPOSITORY:TAG)</li>
<li>REPOSITORY：表示镜像的仓库源，TAG：镜像的标签</li>
</ul>
</li>
<li><p>运行一个容器：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run --name nginx-xd -p 8080:80 -d nginx</span><br><span class="line"></span><br><span class="line">docker run </span><br><span class="line">	--name &quot;xxx&quot;  容器名称</span><br><span class="line">      -p 端口映射</span><br><span class="line"> 	  -d 后台运行</span><br></pre></td></tr></table></figure>
</li>
<li><p>列举当前运行的容器：docker ps</p>
</li>
<li><p>检查容器内部信息：docker inspect 容器名称</p>
</li>
<li><p>删除镜像：docker rmi IMAGE_NAME</p>
</li>
<li><p>强制移除镜像不管是否有容器使用该镜像 增加 -f 参数</p>
</li>
<li><p>停止某个容器：docker stop 容器名称</p>
</li>
<li><p>启动某个容器：docker start 容器名称</p>
</li>
<li><p>移除某个容器： docker rm 容器名称 （容器必须是停止状态）</p>
</li>
<li><p>列举全部容器 ： docker ps -a</p>
</li>
</ul>
<h2 id="容器化部署必备Docker公有-阿里云私有镜像仓库"><a href="#容器化部署必备Docker公有-阿里云私有镜像仓库" class="headerlink" title="容器化部署必备Docker公有+阿里云私有镜像仓库"></a>容器化部署必备Docker公有+阿里云私有镜像仓库</h2><ul>
<li>为啥要用镜像仓库</li>
<li>官方公共镜像仓库和私有镜像仓库(画图)<ul>
<li>公共镜像仓库：<ul>
<li>官方：<a href="https://hub.docker.com/，基于各个软件开发或者有软件提供商开发的" target="_blank" rel="noopener">https://hub.docker.com/，基于各个软件开发或者有软件提供商开发的</a></li>
<li>非官方：其他组织或者公司开发的镜像，供大家免费试用</li>
</ul>
</li>
<li>私有镜像仓库：<ul>
<li>用于存放公司内部的镜像，不提供给外部试用；</li>
</ul>
</li>
</ul>
</li>
<li>开通阿里云私有镜像仓库<ul>
<li>登录阿里云账号访问地址：<ul>
<li><a href="https://cr.console.aliyun.com/" target="_blank" rel="noopener">https://cr.console.aliyun.com/</a></li>
<li><a href="https://cr.console.aliyun.com/cn-shenzhen/instances/credentials" target="_blank" rel="noopener">https://cr.console.aliyun.com/cn-shenzhen/instances/credentials</a></li>
</ul>
</li>
<li>初次使用会提示开通</li>
</ul>
</li>
</ul>
<p><img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/image-20200914155539610.png" alt="image-20200914155539610"></p>
<h2 id="不同系统Docker安装常见问题讲解和解决思路"><a href="#不同系统Docker安装常见问题讲解和解决思路" class="headerlink" title="不同系统Docker安装常见问题讲解和解决思路"></a>不同系统Docker安装常见问题讲解和解决思路</h2><ul>
<li><p>本地需要安装Docker,才可以进行打包，搭建</p>
<ul>
<li>Win7~Win10</li>
<li>Mac</li>
<li>Linux<ul>
<li>CentOS</li>
<li>ubuntu</li>
</ul>
</li>
<li>官方地址<ul>
<li><a href="https://docs.docker.com/docker-for-mac/install/" target="_blank" rel="noopener">https://docs.docker.com/docker-for-mac/install/</a></li>
<li><a href="https://docs.docker.com/docker-for-windows/install/" target="_blank" rel="noopener">https://docs.docker.com/docker-for-windows/install/</a></li>
</ul>
</li>
</ul>
</li>
<li><p>问题</p>
<ul>
<li>镜像下载慢<ul>
<li>搜索修改镜像仓库地址：阿里云、网易云等都有镜像仓库地址（不熟悉不建议乱修改）</li>
</ul>
</li>
<li>根据打包错误日志搜索博文</li>
<li>本地时间不同步</li>
<li>本地网络差，下载包容易超时或者慢（只能等）</li>
</ul>
</li>
<li><p>常规的部署只是Docker的冰山一角</p>
</li>
<li><p>查看容器启动日志</p>
<ul>
<li>docker logs -f containerid</li>
</ul>
</li>
</ul>
<h1 id="JDK11-AlibabaCloud-Docker整合打包镜像推送"><a href="#JDK11-AlibabaCloud-Docker整合打包镜像推送" class="headerlink" title="JDK11+AlibabaCloud+Docker整合打包镜像推送"></a>JDK11+AlibabaCloud+Docker整合打包镜像推送</h1><ul>
<li><p>官方文档：<a href="https://spring.io/guides/gs/spring-boot-docker/" target="_blank" rel="noopener">https://spring.io/guides/gs/spring-boot-docker/</a></p>
</li>
<li><p>父项目的springboot版本依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>11<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>11<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>11<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">spring.boot.version</span>&gt;</span>2.3.3.RELEASE<span class="tag">&lt;/<span class="name">spring.boot.version</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>每个子模块项目添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">//配置文件增加</span><br><span class="line"><span class="tag">&lt;<span class="name">docker.image.prefix</span>&gt;</span>xdclass<span class="tag">&lt;/<span class="name">docker.image.prefix</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>alibaba-cloud-gateway<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">fork</span>&gt;</span>true<span class="tag">&lt;/<span class="name">fork</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">addResources</span>&gt;</span>true<span class="tag">&lt;/<span class="name">addResources</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.spotify<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dockerfile-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">repository</span>&gt;</span>$&#123;docker.image.prefix&#125;/$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">buildArgs</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">JAR_FILE</span>&gt;</span>target/$&#123;project.build.finalName&#125;.jar<span class="tag">&lt;/<span class="name">JAR_FILE</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">buildArgs</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Spotify 的 dockerfile-maven-plugin 插件是用maven插件方式构建docker镜像的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;project.build.finalName&#125; 产出物名称，缺省为$&#123;project.artifactId&#125;-$&#123;project.version&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="镜像打包脚本Dockerfile介绍和【新版JDK11】整合"><a href="#镜像打包脚本Dockerfile介绍和【新版JDK11】整合" class="headerlink" title="镜像打包脚本Dockerfile介绍和【新版JDK11】整合"></a>镜像打包脚本Dockerfile介绍和【新版JDK11】整合</h2><ul>
<li><p>创建Dockerfile,默认是根目录，（可以修改为src/main/docker/Dockerfile,如果修则需要制定路径）</p>
</li>
<li><p>什么是Dockerfile</p>
<ul>
<li>由一系列命令和参数构成的脚本，这些命令应用于基础镜像, 最终创建一个新的镜像</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">FROM  adoptopenjdk&#x2F;openjdk11:ubi</span><br><span class="line">VOLUME &#x2F;tmp</span><br><span class="line">ARG JAR_FILE</span><br><span class="line">COPY $&#123;JAR_FILE&#125; app.jar</span><br><span class="line">ENTRYPOINT [&quot;java&quot;,&quot;-jar&quot;,&quot;&#x2F;app.jar&quot;]</span><br><span class="line"></span><br><span class="line">FROM &lt;image&gt;:&lt;tag&gt; 需要一个基础镜像，可以是公共的或者是私有的，</span><br><span class="line">后续构建会基于此镜像，如果同一个Dockerfile中建立多个镜像时，可以使用多个FROM指令</span><br><span class="line">      </span><br><span class="line">VOLUME  配置一个具有持久化功能的目录，主机 &#x2F;var&#x2F;lib&#x2F;docker 目录下创建了一个临时文件，并链接到容器的&#x2F;tmp。改步骤是可选的，如果涉及到文件系统的应用就很有必要了。</span><br><span class="line">&#x2F;tmp目录用来持久化到 Docker 数据文件夹，因为 Spring Boot 使用的内嵌 Tomcat 容器默认使用&#x2F;tmp作为工作目录 </span><br><span class="line"></span><br><span class="line">ARG  设置编译镜像时加入的参数， JAR_FILE 是设置容器的环境变量(maven里面配置的)</span><br><span class="line">COPY : 只支持将本地文件复制到容器 ,还有个ADD更强大但复杂点</span><br><span class="line">ENTRYPOINT 容器启动时执行的命令</span><br><span class="line"></span><br><span class="line">EXPOSE 8080 暴露镜像端口</span><br></pre></td></tr></table></figure>
</li>
<li><p>构建镜像( 去到子模块pom文件下)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn install -Dmaven.test.skip&#x3D;true dockerfile:build</span><br></pre></td></tr></table></figure>
</li>
<li><p>打包网关镜像</p>
</li>
</ul>
<h2 id="AlibabaCloud-视频服务-订单服务Docker镜像打包"><a href="#AlibabaCloud-视频服务-订单服务Docker镜像打包" class="headerlink" title="AlibabaCloud-视频服务-订单服务Docker镜像打包"></a>AlibabaCloud-视频服务-订单服务Docker镜像打包</h2><ul>
<li>视频服务打包</li>
<li>订单服务打包</li>
</ul>
<h2 id="本地镜像推送阿里云私有镜像仓库"><a href="#本地镜像推送阿里云私有镜像仓库" class="headerlink" title="本地镜像推送阿里云私有镜像仓库"></a>本地镜像推送阿里云私有镜像仓库</h2><ul>
<li><p>阿里云私有镜像仓库创建</p>
</li>
<li><p>网关服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 登录</span></span><br><span class="line">docker login --username=釉釉cxy registry.cn-shenzhen.aliyuncs.com</span><br><span class="line"><span class="comment"># 打标签</span></span><br><span class="line">docker tag 494d49ea5e78 registry.cn-shenzhen.aliyuncs.com/xdclass-cloud/cloud-gateway:v1.0</span><br><span class="line"><span class="comment"># 推送</span></span><br><span class="line">docker push registry.cn-shenzhen.aliyuncs.com/xdclass-cloud/cloud-gateway:v1.0</span><br></pre></td></tr></table></figure>
</li>
<li><p>订单服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker tag 06270304d1ec registry.cn-shenzhen.aliyuncs.com/xdclass-cloud/cloud-order:v1.0</span><br><span class="line"></span><br><span class="line">docker push registry.cn-shenzhen.aliyuncs.com/xdclass-cloud/cloud-order:v1.0</span><br></pre></td></tr></table></figure>
</li>
<li><p>视频服务推送</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker tag 8765039e03cd registry.cn-shenzhen.aliyuncs.com/xdclass-cloud/cloud-video:v1.0</span><br><span class="line"></span><br><span class="line">docker push registry.cn-shenzhen.aliyuncs.com/xdclass-cloud/cloud-video:v1.0</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="微服务公共组件在阿里云ECS容器化部署"><a href="#微服务公共组件在阿里云ECS容器化部署" class="headerlink" title="微服务公共组件在阿里云ECS容器化部署"></a>微服务公共组件在阿里云ECS容器化部署</h1><h2 id="部署实战-阿里云服务器Docker部署Nacos-镜像加速"><a href="#部署实战-阿里云服务器Docker部署Nacos-镜像加速" class="headerlink" title="部署实战-阿里云服务器Docker部署Nacos+镜像加速"></a>部署实战-阿里云服务器Docker部署Nacos+镜像加速</h2><ul>
<li><p>拉取特别慢</p>
<p>文档：<a href="https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors" target="_blank" rel="noopener">https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors</a></p>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在路径/etc/docker/daemon.json 增加下面的配置</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"registry-mirrors"</span>: [<span class="string">"https://pb5bklzr.mirror.aliyuncs.com"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>重启</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>
</li>
<li><p>docker拉取镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull nacos/nacos-server</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动Nacos</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --env MODE=standalone --name xdclass-nacos -d -p 8848:8848 ef8e53226440 (镜像id)</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker logs -f</span><br></pre></td></tr></table></figure>
</li>
<li><p>访问Nacos（记得开放阿里云的网络安全组）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;公网ip:8848&#x2F;nacos</span><br><span class="line"># 登录密码默认nacos&#x2F;nacos</span><br></pre></td></tr></table></figure>
</li>
<li><p>注意docker要启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@iZwz91k9y7fpcuu8cqimofZ ~]# docker pull nacos&#x2F;nacos-server</span><br><span class="line">Using default tag: latest</span><br><span class="line">Cannot connect to the Docker daemon at unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker.sock. Is the docker daemon running?</span><br></pre></td></tr></table></figure>
</li>
<li><p>机器配置，nacos安装在高配机器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">120.24.216.117(公)</span><br><span class="line">172.18.123.230（私有）</span><br><span class="line">2 vCPU 1 GiB (安装了Mysql&#x2F;Zipkin服务)</span><br><span class="line"></span><br><span class="line">112.74.55.160(公)</span><br><span class="line">172.18.123.229（私有）</span><br><span class="line">2 vCPU 4 GiB（安装了Nacos、Sentinel、网关、视频服务、订单服务）</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="部署实战-阿里云ECS服务器Docker部署Sentinel"><a href="#部署实战-阿里云ECS服务器Docker部署Sentinel" class="headerlink" title="部署实战-阿里云ECS服务器Docker部署Sentinel"></a>部署实战-阿里云ECS服务器Docker部署Sentinel</h2><ul>
<li><p>docker拉取镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull bladex&#x2F;sentinel-dashboard:latest</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动Sentinel</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name sentinel -d -p 8858:8858  镜像id</span><br></pre></td></tr></table></figure>
</li>
<li><p>访问Sentinel（记得开放阿里云的网络安全组）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;公网ip:8858</span><br><span class="line"></span><br><span class="line"># 登录密码默认sentinel&#x2F;sentinel</span><br></pre></td></tr></table></figure>
</li>
<li><p>机器配置, 安装在高配机器(就是微服务同个宿主机)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">120.24.216.117(公)</span><br><span class="line">172.18.123.230（私有）</span><br><span class="line">2 vCPU 1 GiB (安装了Mysql&#x2F;Zipkin服务)</span><br><span class="line"> </span><br><span class="line">112.74.55.160(公)</span><br><span class="line">172.18.123.229（私有）</span><br><span class="line">2 vCPU 4 GiB（安装了Nacos、Sentinel、网关、视频服务、订单服务）</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="部署实战-阿里云ECS服务器Docker部署Zipkin实战"><a href="#部署实战-阿里云ECS服务器Docker部署Zipkin实战" class="headerlink" title="部署实战-阿里云ECS服务器Docker部署Zipkin实战"></a>部署实战-阿里云ECS服务器Docker部署Zipkin实战</h2><ul>
<li><p>docker拉取镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull openzipkin&#x2F;zipkin:latest</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动Zipkin</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name xdclass-zipkin -d -p 9411:9411 镜像id</span><br></pre></td></tr></table></figure>
</li>
<li><p>访问zipkin（记得开放阿里云的网络安全组）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;公网ip:9411&#x2F;zipkin&#x2F;</span><br></pre></td></tr></table></figure>
</li>
<li><p>机器配置, 部署在低配服务器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">120.24.216.117(公)</span><br><span class="line">172.18.123.230（私有）</span><br><span class="line">2 vCPU 1 GiB (安装了Mysql&#x2F;Zipkin服务)</span><br><span class="line"></span><br><span class="line">112.74.55.160(公)</span><br><span class="line">172.18.123.229（私有）</span><br><span class="line">2 vCPU 4 GiB（安装了Nacos、Sentinel、网关、视频服务、订单服务）</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="AlibabaCloud微服务阿里云ECS容器化部署"><a href="#AlibabaCloud微服务阿里云ECS容器化部署" class="headerlink" title="AlibabaCloud微服务阿里云ECS容器化部署"></a>AlibabaCloud微服务阿里云ECS容器化部署</h1><h2 id="配置文件Bug修复-网关重新打包推送"><a href="#配置文件Bug修复-网关重新打包推送" class="headerlink" title="配置文件Bug修复-网关重新打包推送"></a>配置文件Bug修复-网关重新打包推送</h2><ul>
<li><p>缺少主文件，本地验证，进入target目录 java -jar xxx.jar 执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">no main manifest attribute, in &#x2F;app.jar</span><br><span class="line"></span><br><span class="line">xxx.jar中没有主清单属性</span><br></pre></td></tr></table></figure>
</li>
<li><p>注意事项</p>
<ul>
<li>重新打包，在聚合工程目录下执行, 不然可能出现类找不到</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mvn clean</span><br><span class="line">mvn install</span><br></pre></td></tr></table></figure>
</li>
<li><p>本地退出远程私有镜像仓库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">logout</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>重新打包推送到私有镜像仓库（如打包超时，可以多试试几次）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">            	<span class="tag">&lt;<span class="name">goal</span>&gt;</span>repackage<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">fork</span>&gt;</span>true<span class="tag">&lt;/<span class="name">fork</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">addResources</span>&gt;</span>true<span class="tag">&lt;/<span class="name">addResources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>注册中心的ip 改为阿里云局域网ip</p>
</li>
<li><p>上述步骤同步更新到网关服务、视频服务、订单服务</p>
</li>
<li><p>机器配置, 部署在低配服务器</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">120.24.216.117(公)</span><br><span class="line">172.18.123.230（私有）</span><br><span class="line">2 vCPU 1 GiB (安装了Mysql&#x2F;Zipkin服务)</span><br><span class="line"></span><br><span class="line">112.74.55.160(公)</span><br><span class="line">172.18.123.229（私有）</span><br><span class="line">2 vCPU 4 GiB（安装了Nacos、Sentinel、网关、视频服务、订单服务）</span><br></pre></td></tr></table></figure>

<ul>
<li>网关打包推送</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker tag 046756142a54 registry.cn-shenzhen.aliyuncs.com&#x2F;xdclass-cloud&#x2F;cloud-gateway:v2.0</span><br><span class="line"></span><br><span class="line">docker push registry.cn-shenzhen.aliyuncs.com&#x2F;xdclass-cloud&#x2F;cloud-gateway:v2.0</span><br></pre></td></tr></table></figure>

<h2 id="网关配置迁移阿里云Nacos配置中心和服务启动"><a href="#网关配置迁移阿里云Nacos配置中心和服务启动" class="headerlink" title="网关配置迁移阿里云Nacos配置中心和服务启动"></a>网关配置迁移阿里云Nacos配置中心和服务启动</h2><ul>
<li><p>阿里云Nacos新建配置 dataId = api-gateway-dev.yaml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8888</span></span><br><span class="line"><span class="string">​</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">api-gateway</span></span><br><span class="line">  <span class="attr">zipkin:</span></span><br><span class="line">    <span class="attr">base-url:</span> <span class="string">http://172.18.123.230:9411/</span> <span class="comment"># zipkin地址 局域网即私网ip</span></span><br><span class="line">    <span class="attr">discovery-client-enabled:</span> <span class="literal">false</span>  <span class="comment">#不用开启服务发现</span></span><br><span class="line">  <span class="attr">sleuth:</span></span><br><span class="line">    <span class="attr">sampler:</span></span><br><span class="line">      <span class="attr">probability:</span> <span class="number">1.0</span> <span class="comment">#采样百分比</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">172.18</span><span class="number">.123</span><span class="number">.229</span><span class="string">:8848</span> <span class="comment"># 局域网即私网ip</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span> <span class="comment">#数组形式</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">order-service</span>  <span class="comment">#路由唯一标识</span></span><br><span class="line">          <span class="comment">#uri: http://127.0.0.1:8000  #想要转发到的地址</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://xdclass-order-service</span>  <span class="comment">#从nocas进行转发</span></span><br><span class="line">          <span class="attr">order:</span> <span class="number">1</span> <span class="comment">#优先级，数字越小优先级越高</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment">#断言 配置哪个路径才转发</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/order-server/**</span></span><br><span class="line">            <span class="comment">#- Before=2020-09-11T01:01:01.000+08:00  # 在这个时间点之后不能访问</span></span><br><span class="line">            <span class="comment">#- Query=source  #一定携带这个参数</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">filters:</span> <span class="comment">#过滤器，请求在传递过程中通过过滤器修改</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">StripPrefix=1</span>  <span class="comment">#去掉第一层前缀</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span>  <span class="comment">#开启网关拉取nacos的服务</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>阿里云网关镜像拉取</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull registry.cn-shenzhen.aliyuncs.com&#x2F;xdclass-cloud&#x2F;cloud-gateway:v2.0</span><br></pre></td></tr></table></figure>
</li>
<li><p>网关容器启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run  --name xdclass-gateway -d -p 8888:8888 镜像id</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="视频和订单服务迁移阿里云Nacos配置中心和镜像打包"><a href="#视频和订单服务迁移阿里云Nacos配置中心和镜像打包" class="headerlink" title="视频和订单服务迁移阿里云Nacos配置中心和镜像打包"></a>视频和订单服务迁移阿里云Nacos配置中心和镜像打包</h2><ul>
<li><p>配置中心新增配置</p>
</li>
<li><p>本地镜像打包推送阿里云镜像仓库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//视频服务</span><br><span class="line">docker tag 53f5604dcd76 registry.cn-shenzhen.aliyuncs.com/xdclass-cloud/cloud-video:v2.0</span><br><span class="line">docker push registry.cn-shenzhen.aliyuncs.com/xdclass-cloud/cloud-video:v2.0</span><br><span class="line"></span><br><span class="line">//订单服务</span><br><span class="line">docker tag 16e0740b7525 registry.cn-shenzhen.aliyuncs.com/xdclass-cloud/cloud-order:v2.0</span><br><span class="line">docker push registry.cn-shenzhen.aliyuncs.com/xdclass-cloud/cloud-order:v2.0</span><br></pre></td></tr></table></figure>
</li>
<li><p>阿里云ecs服务器拉取镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull registry.cn-shenzhen.aliyuncs.com&#x2F;xdclass-cloud&#x2F;cloud-video:v2.0</span><br><span class="line">docker pull registry.cn-shenzhen.aliyuncs.com&#x2F;xdclass-cloud&#x2F;cloud-order:v2.0</span><br></pre></td></tr></table></figure>
</li>
<li><p>机器配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">120.24.216.117(公)</span><br><span class="line">172.18.123.230（私有）</span><br><span class="line">2 vCPU 1 GiB (安装了Mysql&#x2F;Zipkin服务)</span><br><span class="line"></span><br><span class="line">112.74.55.160(公)</span><br><span class="line">172.18.123.229（私有）</span><br><span class="line">2 vCPU 4 GiB（安装了Nacos、Sentinel、网关、视频服务、订单服务）</span><br></pre></td></tr></table></figure>
</li>
<li><p>视频服务配置（后面会修改数据库的地址，这里先不改）</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9000</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">xdclass-video-service</span></span><br><span class="line">  <span class="attr">zipkin:</span></span><br><span class="line">    <span class="attr">base-url:</span> <span class="string">http://172.18.123.230:9411/</span> <span class="comment">#zipkin地址</span></span><br><span class="line">    <span class="attr">discovery-client-enabled:</span> <span class="literal">false</span>  <span class="comment">#不用开启服务发现</span></span><br><span class="line">  <span class="attr">sleuth:</span></span><br><span class="line">    <span class="attr">sampler:</span></span><br><span class="line">      <span class="attr">probability:</span> <span class="number">1.0</span> <span class="comment">#采样百分比</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/cloud_video?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">172.18</span><span class="number">.123</span><span class="number">.229</span><span class="string">:8848</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="number">172.18</span><span class="number">.123</span><span class="number">.229</span><span class="string">:8858</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">9998</span></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">log-impl:</span> <span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br><span class="line">    <span class="attr">map-underscore-to-camel-case:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>订单服务配置（后面会修改数据库的地址，这里先不改）</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">xdclass-order-service</span></span><br><span class="line">  <span class="attr">zipkin:</span></span><br><span class="line">    <span class="attr">base-url:</span> <span class="string">http://172.18.123.230:9411/</span> <span class="comment">#zipkin地址</span></span><br><span class="line">    <span class="attr">discovery-client-enabled:</span> <span class="literal">false</span>  <span class="comment">#不用开启服务发现</span></span><br><span class="line">  <span class="attr">sleuth:</span></span><br><span class="line">    <span class="attr">sampler:</span></span><br><span class="line">      <span class="attr">probability:</span> <span class="number">1.0</span> <span class="comment">#采样百分比</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">172.18</span><span class="number">.123</span><span class="number">.229</span><span class="string">:8848</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="number">172.18</span><span class="number">.123</span><span class="number">.229</span><span class="string">:8858</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">9999</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/cloud_order?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 控制台输出sql、下划线转驼峰</span></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">log-impl:</span> <span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br><span class="line">    <span class="attr">map-underscore-to-camel-case:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#使用随机负载均衡策略</span></span><br><span class="line"><span class="attr">xdclass-video-service:</span></span><br><span class="line">  <span class="attr">ribbon:</span></span><br><span class="line">    <span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.netflix.loadbalancer.RandomRule</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启feign对Sentinel</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">sentinel:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="阿里云ECS服务器快速安装Mysql数据库"><a href="#阿里云ECS服务器快速安装Mysql数据库" class="headerlink" title="阿里云ECS服务器快速安装Mysql数据库"></a>阿里云ECS服务器快速安装Mysql数据库</h2><ul>
<li><p>安装Mysql 5.7 （注意，Mysql和系统务必保持一致，不然存在不一致）</p>
</li>
<li><p>开启mysql远程连接（如果是准线上，建议不要开启远程连接）</p>
</li>
<li><p>开放阿里云网络安全组配置 3306 端口</p>
</li>
<li><p>导入数据库脚本到Mysql</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#下载mysql的Yum仓库</span></span><br><span class="line">wget -i -c http://dev.mysql.com/get/mysql57-community-release-el7-10.noarch.rpm</span><br><span class="line"></span><br><span class="line">yum -y install mysql57-community-release-el7-10.noarch.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment">#安装 mysql服务</span></span><br><span class="line">yum -y install mysql-community-server</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动数据库服务， systemctl 该命令可用于查看系统状态和管理系统及服务，centos7上开始使用</span></span><br><span class="line">systemctl start  mysqld.service</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看状态</span></span><br><span class="line">systemctl status mysqld.service</span><br><span class="line"></span><br><span class="line"><span class="comment">#在日志文件中查看初始密码</span></span><br><span class="line">grep <span class="string">"password"</span> /var/<span class="built_in">log</span>/mysqld.log</span><br><span class="line"></span><br><span class="line"><span class="comment">#进入修改Mysql密码</span></span><br><span class="line">mysql -uroot -p</span><br><span class="line"></span><br><span class="line"><span class="comment">#新密码设置必须由大小写字母、数字和特殊符号组成</span></span><br><span class="line">ALTER USER <span class="string">'root'</span>@<span class="string">'localhost'</span> IDENTIFIED BY <span class="string">'Xdclass.net168'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#开启mysql的远程访问， %是指全部</span></span><br><span class="line">grant all privileges on *.* to <span class="string">'root'</span>@<span class="string">'%'</span> identified by <span class="string">'Xdclass.net168'</span> with grant option;</span><br><span class="line"></span><br><span class="line"><span class="comment">#刷新权限</span></span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="AlibabaCloud视频和订单服务阿里云启动"><a href="#AlibabaCloud视频和订单服务阿里云启动" class="headerlink" title="AlibabaCloud视频和订单服务阿里云启动"></a>AlibabaCloud视频和订单服务阿里云启动</h2><p><strong>视频服务和订单服务容器启动</strong></p>
<ul>
<li><p>订单服务新增配置 video.title（配置动态刷新）</p>
</li>
<li><p>视频服务和订单服务启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run  --name xdclass-video -d -p 9000:9000 53f5604dcd76</span><br><span class="line"></span><br><span class="line">docker run  --name xdclass-order -d -p 8001:8001 16e0740b7525</span><br></pre></td></tr></table></figure>
</li>
<li><p>开放网关服务的网络安全组 8888端口</p>
</li>
<li><p>机器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">120.24.216.117(公)</span><br><span class="line">172.18.123.230（私有）</span><br><span class="line">2 vCPU 1 GiB (安装了Mysql&#x2F;Zipkin服务)</span><br><span class="line"></span><br><span class="line">112.74.55.160(公)</span><br><span class="line">172.18.123.229（私有）</span><br><span class="line">2 vCPU 4 GiB（安装了Nacos、Sentinel、网关、视频服务、订单服务）</span><br></pre></td></tr></table></figure>
</li>
<li><p>视频服务（修改数据库的地址）</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://172.18.123.230:3306/cloud_video?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">Xdclass.net168</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>订单服务（修改数据库的地址）</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://172.18.123.230:3306/cloud_order?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">Xdclass.net168</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>网关服务</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8888</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">api-gateway</span></span><br><span class="line">  <span class="attr">zipkin:</span></span><br><span class="line">    <span class="attr">base-url:</span> <span class="string">http://172.18.123.230:9411/</span> <span class="comment">#zipkin地址</span></span><br><span class="line">    <span class="attr">discovery-client-enabled:</span> <span class="literal">false</span>  <span class="comment">#不用开启服务发现</span></span><br><span class="line">  <span class="attr">sleuth:</span></span><br><span class="line">    <span class="attr">sampler:</span></span><br><span class="line">      <span class="attr">probability:</span> <span class="number">1.0</span> <span class="comment">#采样百分比</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">172.18</span><span class="number">.123</span><span class="number">.229</span><span class="string">:8848</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span> <span class="comment">#数组形式</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">order-service</span>  <span class="comment">#路由唯一标识</span></span><br><span class="line">          <span class="comment">#uri: http://127.0.0.1:8000  #想要转发到的地址</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://xdclass-order-service</span>  <span class="comment">#从nocas进行转发</span></span><br><span class="line">          <span class="attr">order:</span> <span class="number">1</span> <span class="comment">#优先级，数字越小优先级越高</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment">#断言 配置哪个路径才转发</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/order-server/**</span></span><br><span class="line">            <span class="comment">#- Before=2020-09-11T01:01:01.000+08:00  # 在这个时间点之后不能访问</span></span><br><span class="line">            <span class="comment">#- Query=source  #一定携带这个参数</span></span><br><span class="line">          <span class="attr">filters:</span> <span class="comment">#过滤器，请求在传递过程中通过过滤器修改</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">StripPrefix=1</span>  <span class="comment">#去掉第一层前缀</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span>  <span class="comment">#开启网关拉取nacos的服务</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="微服务阿里云部署全链路验证和线上测试"><a href="#微服务阿里云部署全链路验证和线上测试" class="headerlink" title="微服务阿里云部署全链路验证和线上测试"></a>微服务阿里云部署全链路验证和线上测试</h2><ul>
<li>全链路验证</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;112.74.55.160:8888&#x2F;order-server&#x2F;api&#x2F;v1&#x2F;video_order&#x2F;save?videoId&#x3D;41</span><br></pre></td></tr></table></figure>

<ul>
<li>限流验证</li>
<li>配置中心动态刷新验证</li>
<li>链路追踪验证</li>
<li>内外网隔离</li>
</ul>
<p><img src="https://file.xdclass.net/note/2020/alibaba-cloud/img/image-20200914155417300.png" alt="image-20200914155417300"></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Kaluna</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://blog.kaluna.top/2021/04/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%85%A8%E5%AE%B6%E6%A1%B6%20Alibaba%20Cloud+Docker%E5%AE%B9%E5%99%A8%E5%8C%96/">https://blog.kaluna.top/2021/04/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%85%A8%E5%AE%B6%E6%A1%B6%20Alibaba%20Cloud+Docker%E5%AE%B9%E5%99%A8%E5%8C%96/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/docker/">docker</a><a class="post-meta__tags" href="/tags/Nacos/">Nacos</a><a class="post-meta__tags" href="/tags/Ribbon/">Ribbon</a><a class="post-meta__tags" href="/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/">负载均衡</a><a class="post-meta__tags" href="/tags/Open-Feign/">Open-Feign</a><a class="post-meta__tags" href="/tags/Sentinel/">Sentinel</a><a class="post-meta__tags" href="/tags/Zipkin/">Zipkin</a><a class="post-meta__tags" href="/tags/Sleuth/">Sleuth</a><a class="post-meta__tags" href="/tags/Gateway/">Gateway</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="https://i.loli.net/2021/04/20/FbPtxEHeSDgCXBy.jpg"><div class="post-qr-code__desc">添加我为好友</div></div></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2021/04/29/Alibaba%20Cloud%E5%AE%9E%E6%88%98%E4%B9%8B%E6%8A%A5%E9%94%99%E7%AF%87/"><i class="fa fa-chevron-left">  </i><span>Alibaba Cloud实战之报错篇</span></a></div><div class="next-post pull-right"><a href="/2021/04/22/Jenkins%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%20Git%20Gitlab%20Sonar/"><span>Jenkins持续集成 Git Gitlab Sonar</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'https://blog.kaluna.top/2021/04/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%85%A8%E5%AE%B6%E6%A1%B6%20Alibaba%20Cloud+Docker%E5%AE%B9%E5%99%A8%E5%8C%96/';
  this.page.identifier = '2021/04/29/微服务全家桶 Alibaba Cloud+Docker容器化/';
  this.page.title = '微服务全家桶 Alibaba Cloud+Docker容器化';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'shortname-pzy8cndfkq' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script><script id="dsq-count-scr" src="https://shortname-pzy8cndfkq.disqus.com/count.js" async></script></div></div><footer class="footer-bg" style="background-image: url(https://gitee.com/YuerryHUAHUA/figure/raw/master/img/20210521080208.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2021 By Kaluna</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="icp"><a><span></span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>